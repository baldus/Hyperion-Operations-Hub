{% extends "base.html" %}
{% block content %}
<h2>Create Order</h2>
<form method="post" id="new-order-form" class="form-stack">
    <section class="form-section">
        <h3>Order Details</h3>
        <div class="form-grid">
            <label class="form-field">
                <span class="field-label">Order Number</span>
                <input type="text" name="order_number" value="{{ form_data.order_number }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Customer Name</span>
                <input type="text" name="customer_name" value="{{ form_data.customer_name }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Finished Good Part Number</span>
                <input type="text" name="finished_good_sku" list="item-skus" value="{{ form_data.finished_good_sku }}" required>
                <datalist id="item-skus">
                    {% for item in items %}
                    <option value="{{ item.sku }}">{{ item.name }}</option>
                    {% endfor %}
                </datalist>
            </label>
            <label class="form-field">
                <span class="field-label">Order Created By</span>
                <input type="text" name="created_by" value="{{ form_data.created_by }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Quantity</span>
                <input type="number" name="quantity" min="1" value="{{ form_data.quantity }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Promised Ship Date</span>
                <input type="date" name="promised_date" value="{{ form_data.promised_date }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Scheduled Start Date</span>
                <input type="date" name="scheduled_start_date" value="{{ form_data.scheduled_start_date }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Scheduled Completion Date</span>
                <input type="date" name="scheduled_completion_date" value="{{ form_data.scheduled_completion_date }}" required>
            </label>
        </div>
        <label class="form-field">
            <span class="field-label">General Notes</span>
            <textarea name="general_notes" rows="4">{{ form_data.general_notes }}</textarea>
        </label>
    </section>

    <section class="form-section">
        <div class="section-header">
            <h3>Bill of Materials</h3>
            <div class="section-actions">
                <button type="button" class="action-btn secondary" id="import-bom-button">Import Saved BOM</button>
                <button type="button" class="action-btn" id="add-bom-component">Add Component</button>
            </div>
        </div>
        <p class="section-help">List each component required to manufacture the finished good. Use valid component SKUs from inventory.</p>
        <div id="bom-import-status" class="status-message" {% if form_data.bom_prompt_state == 'none' %}style="display:none;"{% endif %}>
            {% if form_data.bom_prompt_state == 'missing' %}
                No saved bill of material was found for {{ form_data.finished_good_sku or 'this part' }}. Configure the components below and choose whether to save them.
            {% elif form_data.bom_prompt_state == 'imported' %}
                Bill of material loaded from the library. Review and adjust as needed.
            {% endif %}
        </div>
        <div id="bom-save-prompt" class="bom-save-prompt" {% if form_data.bom_prompt_state != 'missing' %}style="display:none;"{% endif %}>
            <label class="checkbox-field">
                <input type="checkbox" id="persist-bom-checkbox" {% if form_data.persist_bom %}checked{% endif %}>
                <span>Save this bill of material to the library when the order is submitted.</span>
            </label>
        </div>
        <div class="table-scroll">
            <table class="form-table">
                <thead>
                    <tr>
                        <th>Component SKU</th>
                        <th>Quantity Per</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bom-rows"></tbody>
            </table>
        </div>
    </section>

    <section class="form-section">
        <div class="section-header">
            <h3>Routing Steps</h3>
            <button type="button" class="action-btn" id="add-routing-step">Add Step</button>
        </div>
        <p class="section-help">Define the work sequence, indicating the work cell, instructions, and which components are consumed during the step.</p>
        <div class="table-scroll">
            <table class="form-table">
                <thead>
                    <tr>
                        <th>Sequence</th>
                        <th>Work Cell</th>
                        <th>Instructions</th>
                        <th>Components Used</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="routing-rows"></tbody>
            </table>
        </div>
    </section>

    <input type="hidden" name="bom_data" id="bom-data">
    <input type="hidden" name="routing_data" id="routing-data">
    <input type="hidden" name="bom_prompt_state" id="bom-prompt-state" value="{{ form_data.bom_prompt_state }}">
    <input type="hidden" name="persist_bom" id="persist-bom-flag" value="{{ 'yes' if form_data.persist_bom else 'no' }}">

    <div class="form-actions">
        <button type="submit" class="action-btn">Create Order</button>
        <a href="{{ url_for('orders.orders_home') }}" class="action-btn secondary">Cancel</a>
    </div>
</form>

<script>
(function() {
    const initialData = {{ form_data|tojson }};
    const bomBody = document.getElementById('bom-rows');
    const routingBody = document.getElementById('routing-rows');
    const bomDataInput = document.getElementById('bom-data');
    const routingDataInput = document.getElementById('routing-data');
    const addBomButton = document.getElementById('add-bom-component');
    const addRoutingButton = document.getElementById('add-routing-step');
    const form = document.getElementById('new-order-form');
    const importBomButton = document.getElementById('import-bom-button');
    const finishedGoodInput = document.querySelector('input[name="finished_good_sku"]');
    const bomStatus = document.getElementById('bom-import-status');
    const bomPromptStateInput = document.getElementById('bom-prompt-state');
    const bomSavePrompt = document.getElementById('bom-save-prompt');
    const persistBomInput = document.getElementById('persist-bom-flag');
    const persistBomCheckbox = document.getElementById('persist-bom-checkbox');

    function showStatus(state, message) {
        if (!bomStatus) {
            return;
        }
        bomStatus.dataset.state = state;
        if (message) {
            bomStatus.textContent = message;
            bomStatus.style.display = 'block';
        } else {
            bomStatus.textContent = '';
            bomStatus.style.display = 'none';
        }
    }

    function setPromptState(state, message) {
        if (bomPromptStateInput) {
            bomPromptStateInput.value = state;
        }
        if (state === 'missing') {
            if (bomSavePrompt) {
                bomSavePrompt.style.display = 'block';
            }
            if (message === undefined) {
                message = 'No saved bill of material was found. Configure the components below.';
            }
        } else {
            if (bomSavePrompt) {
                bomSavePrompt.style.display = 'none';
            }
            if (state === 'imported' && message === undefined) {
                message = 'Bill of material loaded from the library.';
            }
        }
        showStatus(state, message || '');
    }

    function clearBomRows() {
        while (bomBody && bomBody.firstChild) {
            bomBody.removeChild(bomBody.firstChild);
        }
    }

    function createBomRow(values = {}) {
        const row = document.createElement('tr');
        row.classList.add('bom-row');
        row.innerHTML = `
            <td>
                <input type="text" class="bom-sku" placeholder="Component SKU" list="item-skus">
            </td>
            <td>
                <input type="number" class="bom-quantity" min="1" placeholder="Qty">
            </td>
            <td class="row-actions">
                <button type="button" class="link-btn remove-bom">Remove</button>
            </td>
        `;
        const skuInput = row.querySelector('.bom-sku');
        const quantityInput = row.querySelector('.bom-quantity');
        if (values.sku !== undefined) {
            skuInput.value = values.sku;
        }
        if (values.quantity !== undefined) {
            quantityInput.value = values.quantity;
        }
        skuInput.addEventListener('input', updateStepComponentOptions);
        quantityInput.addEventListener('input', updateStepComponentOptions);
        row.querySelector('.remove-bom').addEventListener('click', () => {
            row.remove();
            updateStepComponentOptions();
        });
        bomBody.appendChild(row);
        updateStepComponentOptions();
    }

    function createRoutingRow(values = {}) {
        const row = document.createElement('tr');
        row.classList.add('routing-row');
        row.dataset.selectedComponents = JSON.stringify(values.components || []);
        row.innerHTML = `
            <td>
                <input type="number" class="step-sequence" min="1" placeholder="#">
            </td>
            <td>
                <input type="text" class="step-work-cell" placeholder="Work Cell">
            </td>
            <td>
                <textarea class="step-instructions" rows="2" placeholder="Detailed instructions" required></textarea>
            </td>
            <td>
                <select multiple class="step-components-select"></select>
            </td>
            <td class="row-actions">
                <button type="button" class="link-btn remove-step">Remove</button>
            </td>
        `;
        const sequenceInput = row.querySelector('.step-sequence');
        const workCellInput = row.querySelector('.step-work-cell');
        const instructionsInput = row.querySelector('.step-instructions');
        if (values.sequence !== undefined) {
            sequenceInput.value = values.sequence;
        }
        if (values.work_cell !== undefined) {
            workCellInput.value = values.work_cell;
        }
        if (values.instructions !== undefined) {
            instructionsInput.value = values.instructions;
        }
        row.querySelector('.remove-step').addEventListener('click', () => {
            row.remove();
        });
        const select = row.querySelector('.step-components-select');
        select.addEventListener('change', () => {
            row.dataset.selectedComponents = JSON.stringify(Array.from(select.selectedOptions).map(opt => opt.value));
        });
        routingBody.appendChild(row);
        updateStepComponentOptions();
    }

    function getBomOptions() {
        return Array.from(bomBody.querySelectorAll('tr')).map(row => {
            const sku = row.querySelector('.bom-sku').value.trim();
            const quantity = row.querySelector('.bom-quantity').value.trim();
            return { sku, quantity };
        }).filter(component => component.sku !== '');
    }

    function updateStepComponentOptions() {
        const components = getBomOptions();
        routingBody.querySelectorAll('.routing-row').forEach(row => {
            const select = row.querySelector('.step-components-select');
            const existingSelection = new Set(Array.from(select.selectedOptions).map(opt => opt.value));
            let configuredSelection = [];
            try {
                configuredSelection = JSON.parse(row.dataset.selectedComponents || '[]');
            } catch (err) {
                configuredSelection = [];
            }
            select.innerHTML = '';
            components.forEach(component => {
                const option = document.createElement('option');
                option.value = component.sku;
                const qtyLabel = component.quantity ? ` (qty ${component.quantity})` : '';
                option.textContent = `${component.sku}${qtyLabel}`;
                if (existingSelection.size > 0) {
                    option.selected = existingSelection.has(component.sku);
                } else if (configuredSelection.includes(component.sku)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            row.dataset.selectedComponents = JSON.stringify(Array.from(select.selectedOptions).map(opt => opt.value));
        });
    }

    function collectBomPayload() {
        const entries = [];
        bomBody.querySelectorAll('tr').forEach(row => {
            const sku = row.querySelector('.bom-sku').value.trim();
            const quantityValue = row.querySelector('.bom-quantity').value.trim();
            if (!sku && !quantityValue) {
                return;
            }
            entries.push({ sku: sku, quantity: quantityValue });
        });
        return entries;
    }

    function collectRoutingPayload() {
        const entries = [];
        routingBody.querySelectorAll('.routing-row').forEach(row => {
            const sequenceValue = row.querySelector('.step-sequence').value.trim();
            const workCell = row.querySelector('.step-work-cell').value.trim();
            const instructions = row.querySelector('.step-instructions').value.trim();
            const components = Array.from(row.querySelector('.step-components-select').selectedOptions).map(opt => opt.value);
            if (!sequenceValue && !instructions && components.length === 0) {
                return;
            }
            entries.push({
                sequence: sequenceValue,
                work_cell: workCell,
                instructions: instructions,
                components: components,
            });
        });
        return entries;
    }

    addBomButton.addEventListener('click', () => createBomRow());
    addRoutingButton.addEventListener('click', () => createRoutingRow());

    if (persistBomCheckbox) {
        persistBomCheckbox.addEventListener('change', () => {
            if (persistBomInput) {
                persistBomInput.value = persistBomCheckbox.checked ? 'yes' : 'no';
            }
        });
    }

    if (importBomButton) {
        importBomButton.addEventListener('click', async () => {
            if (!finishedGoodInput) {
                return;
            }
            const sku = finishedGoodInput.value.trim();
            if (!sku) {
                setPromptState('error', 'Enter the finished good SKU before importing a bill of material.');
                return;
            }

            importBomButton.disabled = true;
            setPromptState('loading', 'Searching for a saved bill of materialâ€¦');
            try {
                const response = await fetch(`/inventory/api/bom/${encodeURIComponent(sku)}`, {
                    headers: { 'Accept': 'application/json' },
                });
                if (response.ok) {
                    const payload = await response.json();
                    clearBomRows();
                    if (Array.isArray(payload.components) && payload.components.length) {
                        payload.components.forEach(component => {
                            createBomRow({ sku: component.sku, quantity: component.quantity });
                        });
                    } else {
                        createBomRow({});
                    }
                    if (persistBomCheckbox) {
                        persistBomCheckbox.checked = false;
                    }
                    if (persistBomInput) {
                        persistBomInput.value = 'no';
                    }
                    const fg = payload.finished_good && payload.finished_good.sku ? payload.finished_good.sku : sku;
                    setPromptState('imported', `Bill of material loaded for ${fg}.`);
                } else if (response.status === 404) {
                    if (!bomBody.querySelector('.bom-row')) {
                        createBomRow({});
                    }
                    if (persistBomCheckbox) {
                        persistBomCheckbox.checked = true;
                    }
                    if (persistBomInput) {
                        persistBomInput.value = 'yes';
                    }
                    setPromptState('missing', `No saved bill of material was found for ${sku}.`);
                } else if (response.status === 403) {
                    setPromptState('error', 'Admin access has expired. Please log in again to import a bill of material.');
                } else {
                    setPromptState('error', 'Unable to import the bill of material at this time.');
                }
            } catch (err) {
                setPromptState('error', 'A network error occurred while importing the bill of material.');
            } finally {
                importBomButton.disabled = false;
                updateStepComponentOptions();
            }
        });
    }

    const initialBom = Array.isArray(initialData.bom) && initialData.bom.length ? initialData.bom : [{}];
    initialBom.forEach(component => createBomRow(component));

    const initialSteps = Array.isArray(initialData.steps) && initialData.steps.length ? initialData.steps : [{}];
    initialSteps.forEach(step => createRoutingRow(step));

    if (persistBomInput) {
        persistBomInput.value = initialData.persist_bom ? 'yes' : 'no';
    }
    if (persistBomCheckbox) {
        persistBomCheckbox.checked = Boolean(initialData.persist_bom);
    }
    setPromptState(initialData.bom_prompt_state || 'none');

    form.addEventListener('submit', () => {
        const bomPayload = collectBomPayload();
        const routingPayload = collectRoutingPayload();
        bomDataInput.value = JSON.stringify(bomPayload);
        routingDataInput.value = JSON.stringify(routingPayload);
    });
})();
</script>
{% endblock %}
