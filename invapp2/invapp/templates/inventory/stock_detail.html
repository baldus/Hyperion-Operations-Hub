{% extends "base.html" %}
{% block content %}
<h2>Item Stock Detail</h2>

<div class="stock-detail-header">
  <div>
    {% set item_label = item.sku ~ " - " ~ item.name if item else "Item" %}
    {% if item and item.id %}
      <h3>
        <a href="{{ url_for('inventory.view_item', item_id=item.id) }}">{{ item_label }}</a>
      </h3>
    {% else %}
      <h3>{{ item_label }}</h3>
    {% endif %}
    <p class="muted">{{ item.description or "" if item else "" }}</p>
    <p>
      <strong>Unit:</strong> {{ item.unit or "" if item else "" }}
      <span class="stock-detail-metric"><strong>Total on hand:</strong> {{ total_on_hand }}</span>
      <span class="stock-detail-metric">
        <strong>Batches:</strong>
        {% if batch_count == 1 %}
          1 Batch
        {% else %}
          {{ batch_count }} Batches
        {% endif %}
      </span>
    </p>
  </div>
</div>

{% if not can_edit %}
  <p class="muted">You have view-only access to stock balances.</p>
{% endif %}

<div class="table-container">
  <table class="inventory-table">
    <thead>
      <tr>
        <th>Location</th>
        <th>Lot/Batch</th>
        <th>Quantity</th>
        <th>Last Updated</th>
        <th>Updated By</th>
        {% if can_edit %}
          <th>Adjust</th>
          <th>Remove</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% if locations %}
        {% for row in locations %}
          <tr>
            <td>{{ row.location.code if row.location else "Unknown" }}</td>
            <td>{{ row.batch_label }}</td>
            <td>
              {% if row.pending_qty %}
                <span class="badge">Qty Pending</span>
              {% else %}
                {{ row.quantity }}
              {% endif %}
            </td>
            <td>
              {% if row.updated_at %}
                {{ row.updated_at.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ row.updated_by or "-" }}</td>
            {% if can_edit %}
              <td>
                <form method="post" action="{{ url_for('inventory.set_stock_quantity', item_id=item.id) }}" class="inline-form">
                  <input type="hidden" name="location_id" value="{{ row.location.id }}">
                  <input type="number" name="quantity" step="0.001" min="0" value="{{ row.quantity }}" class="short-input">
                  <button type="submit" class="bubble-btn">Save</button>
                </form>
              </td>
              <td>
                <button
                  type="button"
                  class="bubble-btn danger remove-from-location-btn"
                  data-item-id="{{ item.id }}"
                  data-item-label="{{ item.sku }} - {{ item.name }}"
                  data-location-id="{{ row.location.id }}"
                  data-location-label="{{ row.location.code }}"
                  data-qty="{{ row.quantity }}"
                  data-batch-id="{{ row.batch_id if row.batch_id is not none else '' }}"
                  data-lot-number="{{ row.batch_label }}"
                  data-batch-count="{{ row.batch_count }}"
                >
                  Remove from Location
                </button>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="{{ 7 if can_edit else 5 }}">No stock movements recorded for this item yet.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if can_edit %}
  <div class="stock-detail-actions">
    <div class="stock-action-card">
      <h4>Transfer Stock</h4>
      <form method="post" action="{{ url_for('inventory.transfer_stock', item_id=item.id) }}" class="stock-action-form">
        <label for="from_location_id">From</label>
        <select id="from_location_id" name="from_location_id" required>
          <option value="">Select location</option>
          {% for row in transfer_from_locations %}
            <option value="{{ row.location.id }}">{{ row.location.code }} ({{ row.quantity }})</option>
          {% endfor %}
        </select>
        <label for="to_location_id">To</label>
        <select id="to_location_id" name="to_location_id" required>
          <option value="">Select location</option>
          {% for location in all_locations %}
            <option value="{{ location.id }}">{{ location.code }}</option>
          {% endfor %}
        </select>
        <label for="transfer_quantity">Quantity</label>
        <input type="number" id="transfer_quantity" name="quantity" step="0.001" min="0" required>
        <label for="transfer_reference">Reference</label>
        <input type="text" id="transfer_reference" name="reference" placeholder="Optional note">
        <button type="submit" class="bubble-btn">Transfer</button>
      </form>
    </div>

    <div class="stock-action-card">
      <h4>Add Location</h4>
      <form method="post" action="{{ url_for('inventory.add_stock_location', item_id=item.id) }}" class="stock-action-form">
        <label for="add_location_id">Location</label>
        <select id="add_location_id" name="location_id" required>
          <option value="">Select location</option>
          {% for location in available_locations %}
            <option value="{{ location.id }}">{{ location.code }}</option>
          {% endfor %}
        </select>
        <label for="add_quantity">Initial Quantity</label>
        <input type="number" id="add_quantity" name="quantity" step="0.001" min="0" value="0">
        <label for="add_reference">Reference</label>
        <input type="text" id="add_reference" name="reference" placeholder="Optional note">
        <button type="submit" class="bubble-btn">Add Location</button>
      </form>
    </div>
  </div>
{% endif %}

{% if can_edit %}
  {% include "inventory/_remove_from_location_modal.html" %}
{% endif %}

<p><a href="{{ url_for('inventory.list_stock') }}">&larr; Back to Stock Overview</a></p>
{% if can_edit %}
  <script src="{{ url_for('static', filename='js/inventory-remove-from-location.js') }}"></script>
{% endif %}
{% endblock %}
