{% extends "base.html" %}
{% block content %}
<style>
  @media print {
    nav,
    .no-print,
    .btn,
    .alert {
      display: none !important;
    }
    .print-header {
      display: block;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .location-section {
      page-break-inside: avoid;
    }
  }
  .print-header {
    display: none;
  }
</style>

<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <h2>Count Sheets (By Aisle) — Snapshot #{{ snapshot.id }}</h2>
    <p class="field-note">
      Created {{ snapshot.created_at.strftime('%Y-%m-%d %H:%M') }}{% if snapshot.source_filename %} from {{ snapshot.source_filename }}{% endif %}.
    </p>
    {% if not snapshot.source_filename %}
    <p class="field-note">No ERP totals uploaded — displaying Ops Console stock rows only.</p>
    {% endif %}
  </div>
  <div class="no-print">
    <button type="button" class="btn btn-outline-primary" onclick="window.print()">Print this aisle</button>
    <a href="{{ url_for('inventory.physical_inventory_snapshot', snapshot_id=snapshot.id) }}" class="btn btn-outline-secondary">Back to Snapshot</a>
  </div>
</div>

{% if selected_aisle %}
<div class="print-header">Aisle {{ selected_aisle }}</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

{% if aisles %}
<form method="get" class="row g-2 align-items-end no-print mb-3">
  <div class="col-sm-6 col-md-4">
    <label for="aisleSelect" class="form-label">Select Aisle</label>
    <select name="aisle" id="aisleSelect" class="form-select" onchange="this.form.submit()">
      {% for aisle in aisles %}
      <option value="{{ aisle }}" {% if aisle == selected_aisle %}selected{% endif %}>{{ aisle }}</option>
      {% endfor %}
    </select>
  </div>
</form>
{% endif %}

{% if not aisles %}
<p>No aisles were found for this snapshot.</p>
{% elif rows %}
<div class="table-responsive">
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Aisle</th>
        <th>Location Code</th>
        <th>Location Description</th>
        <th>Item Name</th>
        <th>Item Description</th>
        <th>SKU</th>
        <th>ERP Total Qty</th>
        <th>Counted Qty</th>
        <th>Notes</th>
      </tr>
    </thead>
    {% for location_group in rows|groupby('location_code') %}
    <tbody class="location-section">
      <tr class="table-secondary">
        <td colspan="9">
          <strong>Location {{ location_group.grouper }}</strong>
          {% if location_group.list[0].location_description %}
          — {{ location_group.list[0].location_description }}
          {% endif %}
        </td>
      </tr>
      {% for row in location_group.list %}
      <tr>
        <td>{{ row.aisle }}</td>
        <td>{{ row.location_code }}</td>
        <td>{{ row.location_description }}</td>
        <td>{{ row.item_name }}</td>
        <td>{{ row.item_description }}</td>
        <td>{{ row.sku }}</td>
        <td>{{ row.erp_quantity }}</td>
        <td>{{ row.counted_quantity if row.counted_quantity is not none else '' }}</td>
        <td></td>
      </tr>
      {% endfor %}
    </tbody>
    {% endfor %}
  </table>
</div>
{% else %}
<p>No rows found for this aisle.</p>
{% endif %}
{% endblock %}
