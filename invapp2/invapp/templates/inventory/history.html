{% extends "base.html" %}
{% block content %}
<h2>Transaction History</h2>

<div>
  <a href="{{ url_for('inventory.export_history') }}" class="bubble-btn">Download CSV</a>
  {% if current_user.is_authenticated and current_user.has_role('admin') and records %}
  <form method="post" action="{{ url_for('inventory.delete_all_history') }}" class="inline-form" onsubmit="return confirm('Are you sure you want to delete all transaction history? This will remove all recorded stock movements.');">
    <button type="submit" class="bubble-btn danger">Delete All History</button>
  </form>
  {% endif %}
</div>
<br>

<div class="table-container">
  <table class="inventory-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>SKU</th>
        <th>Item</th>
        <th>Movement Type</th>
        <th>Quantity</th>
        <th>Location</th>
        <th>Lot/Batch</th>
        <th>Person</th>
        <th>Reference</th>
        <th>PO Number</th>
      </tr>
    </thead>
    <tbody>
      {% for mv in records %}
      <tr>
        <td>{{ mv.date.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>{{ items[mv.item_id].sku if mv.item_id in items else "???" }}</td>
        <td>{{ items[mv.item_id].name if mv.item_id in items else "Unknown Item" }}</td>
        <td>{{ mv.movement_type }}</td>
        <td>{{ mv.quantity }}</td>
        <td>{{ locations[mv.location_id].code if mv.location_id in locations else "-" }}</td>
        <td>
          {% if mv.batch_id and mv.batch_id in batches %}
            {{ batches[mv.batch_id].lot_number }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ mv.person or "-" }}</td>
        <td>{{ mv.reference or "-" }}</td>
        <td>{{ mv.po_number or "-" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
