{% extends "base.html" %}
{% block content %}
<h2>Stock Overview</h2>

<div class="stock-search" style="margin-bottom: 15px;">
  <form method="get" class="stock-search-form" style="display: inline-flex; gap: 8px; align-items: center;">
    <input type="text" name="search" placeholder="Search by SKU, item, lot, or location" value="{{ search }}" style="padding: 4px 8px;">
    <input type="hidden" name="status" value="{{ status }}">
    <input type="hidden" name="size" value="{{ size }}">
    <button type="submit" class="bubble-btn">Search</button>
  </form>
</div>

<div class="stock-filters" style="margin-bottom: 15px;">
  <form method="get" class="status-filter-form" style="display: inline-flex; gap: 8px; align-items: center;">
    <label for="status">Show:</label>
    <select id="status" name="status" onchange="this.form.submit()">
      <option value="all" {% if status == 'all' %}selected{% endif %}>All stock</option>
      <option value="low" {% if status == 'low' %}selected{% endif %}>Low stock (&lt;105% of min)</option>
      <option value="near" {% if status == 'near' %}selected{% endif %}>Near minimum (&lt;125% of min)</option>
    </select>
    <input type="hidden" name="size" value="{{ size }}">
    <input type="hidden" name="search" value="{{ search }}">
  </form>
</div>

<!-- Action buttons -->
<div style="margin-bottom: 15px;">
  <a href="{{ url_for('inventory.adjust_stock') }}" class="bubble-btn">Manual Adjustment</a>
  <a href="{{ url_for('inventory.import_stock') }}" class="bubble-btn">Bulk Import Adjustments (CSV)</a>
  <a href="{{ url_for('inventory.export_stock') }}" class="bubble-btn">Export Stock</a>
  {% if current_user.is_authenticated and current_user.has_role('admin') %}
  <form method="post" action="{{ url_for('inventory.delete_all_stock') }}" class="inline-form" onsubmit="return confirm('Are you sure you want to delete all stock records? This will remove all stock movements and batches.');">
    <button type="submit" class="bubble-btn danger">Delete All Stock Records</button>
  </form>
  {% endif %}
</div>

<!-- Totals by SKU table -->
<h3>Totals by SKU</h3>
<div class="table-container">
  <table class="inventory-table">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Item</th>
        <th>Total On Hand</th>
        <th>Min Stock</th>
      </tr>
    </thead>
    <tbody>
      {% if totals %}
        {% for item_id, total in totals.items() %}
          {% set item = items[item_id] %}
          {% set min_stock = item.min_stock or 0 %}
          {% if total < (min_stock * 1.05) %}
            {% set row_class = "low-red" %}
          {% elif total < (min_stock * 1.25) %}
            {% set row_class = "low-yellow" %}
          {% else %}
            {% set row_class = "" %}
          {% endif %}
          <tr class="{{ row_class }}">
            <td>{{ item.sku }}</td>
            <td>{{ item.name }}</td>
            <td>{{ total }}</td>
            <td>{{ min_stock }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="4">No items match the selected filter.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Detailed balances by batch/location -->
<h3>Detailed Balances</h3>
<div class="table-container">
  <table class="inventory-table">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Item</th>
        <th>Batch / Lot</th>
        <th>Location</th>
        <th>Quantity</th>
      </tr>
    </thead>
    <tbody>
      {% if balances %}
        {% for bal in balances %}
        <tr>
          <td>{{ bal.item.sku if bal.item else "???" }}</td>
          <td>{{ bal.item.name if bal.item else "Unknown" }}</td>
          <td>{{ bal.batch.lot_number if bal.batch else "-" }}</td>
          <td>{{ bal.location.code if bal.location else "-" }}</td>
          <td>{{ bal.on_hand }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5">No location-level balances for the selected filter.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
<div class="pagination">
  {% if page > 1 %}
    <a href="{{ url_for('inventory.list_stock', page=page-1, size=size, status=status, search=search) }}">Previous</a>
  {% endif %}
  {% if page < pages %}
    <a href="{{ url_for('inventory.list_stock', page=page+1, size=size, status=status, search=search) }}">Next</a>
  {% endif %}
</div>
{% endblock %}
