{% extends "base.html" %}
{% block content %}
<h2>Stock Overview</h2>

<div class="stock-filter-panel">
  <form method="get" class="stock-filter-form">
    <div class="filter-group">
      <label for="q">Search</label>
      <input
        type="text"
        id="q"
        name="q"
        placeholder="Search by SKU, name, description"
        value="{{ search }}"
      >
    </div>
    <div class="filter-group">
      <label for="location_id">Location</label>
      <select id="location_id" name="location_id">
        <option value="">All locations</option>
        {% for location in locations %}
          <option value="{{ location.id }}" {% if location_id == location.id %}selected{% endif %}>
            {{ location.code }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group checkbox-group">
      <label for="in_stock">
        <input type="checkbox" id="in_stock" name="in_stock" value="1" {% if in_stock %}checked{% endif %}>
        Only show items with stock &gt; 0
      </label>
    </div>
    <div class="filter-group">
      <label for="status">Status</label>
      <select id="status" name="status">
        <option value="all" {% if status == 'all' %}selected{% endif %}>All stock</option>
        <option value="low" {% if status == 'low' %}selected{% endif %}>Low stock (&lt;105% of min)</option>
        <option value="near" {% if status == 'near' %}selected{% endif %}>Near minimum (&lt;125% of min)</option>
      </select>
    </div>
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="hidden" name="dir" value="{{ direction }}">
    <input type="hidden" name="size" value="{{ size }}">
    <button type="submit" class="bubble-btn">Apply Filters</button>
    <a href="{{ url_for('inventory.list_stock') }}" class="bubble-btn">Reset</a>
  </form>
</div>

<!-- Action buttons -->
<div style="margin-bottom: 15px;">
  <a href="{{ url_for('inventory.adjust_stock') }}" class="bubble-btn">Manual Adjustment</a>
  <a href="{{ url_for('inventory.import_stock') }}" class="bubble-btn">Bulk Import Adjustments (CSV)</a>
  <a href="{{ url_for('inventory.export_stock') }}" class="bubble-btn">Export Stock</a>
  {% if current_user.is_authenticated and current_user.has_role('admin') %}
  <form method="post" action="{{ url_for('inventory.delete_all_stock') }}" class="inline-form" onsubmit="return confirm('Are you sure you want to delete all stock records? This will remove all stock movements and batches.');">
    <button type="submit" class="bubble-btn danger">Delete All Stock Records</button>
  </form>
  {% endif %}
</div>

<!-- Totals by SKU table -->
<div class="table-container">
  <table class="inventory-table stock-overview-table">
    <thead>
      <tr>
        <th>
          <a href="{{ build_stock_url(sort='sku', dir='desc' if sort == 'sku' and direction == 'asc' else 'asc', page=1) }}">
            SKU
            {% if sort == 'sku' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
        <th>
          <a href="{{ build_stock_url(sort='name', dir='desc' if sort == 'name' and direction == 'asc' else 'asc', page=1) }}">
            Item
            {% if sort == 'name' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
        <th>
          <a href="{{ build_stock_url(sort='qty', dir='desc' if sort == 'qty' and direction == 'asc' else 'asc', page=1) }}">
            Total On Hand
            {% if sort == 'qty' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
        <th>Batches</th>
        <th>
          <a href="{{ build_stock_url(sort='locations', dir='desc' if sort == 'locations' and direction == 'asc' else 'asc', page=1) }}">
            Locations
            {% if sort == 'locations' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
        <th>
          <a href="{{ build_stock_url(sort='primary', dir='desc' if sort == 'primary' and direction == 'asc' else 'asc', page=1) }}">
            Primary Location
            {% if sort == 'primary' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
        <th>Secondary</th>
        <th>POU</th>
        <th>
          <a href="{{ build_stock_url(sort='min_stock', dir='desc' if sort == 'min_stock' and direction == 'asc' else 'asc', page=1) }}">
            Min Stock
            {% if sort == 'min_stock' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
        <th>
          <a href="{{ build_stock_url(sort='updated', dir='desc' if sort == 'updated' and direction == 'asc' else 'asc', page=1) }}">
            Last Updated
            {% if sort == 'updated' %}
              <span class="sort-indicator">{{ '▲' if direction == 'asc' else '▼' }}</span>
            {% endif %}
          </a>
        </th>
      </tr>
    </thead>
    <tbody>
      {% if entries %}
        {% for entry in entries %}
          {% set min_stock = entry.item.min_stock or 0 %}
          {% if entry.total_qty < (min_stock * 1.05) %}
            {% set row_class = "low-red" %}
          {% elif entry.total_qty < (min_stock * 1.25) %}
            {% set row_class = "low-yellow" %}
          {% else %}
            {% set row_class = "" %}
          {% endif %}
          <tr class="clickable-row {{ row_class }}" data-href="{{ url_for('inventory.stock_detail', item_id=entry.item.id) }}">
            <td>{{ entry.item.sku }}</td>
            <td>{{ entry.item.name }}</td>
            <td>{{ entry.total_qty }}</td>
            <td>
              {% if entry.batch_count == 1 %}
                1 Batch
              {% else %}
                {{ entry.batch_count }} Batches
              {% endif %}
            </td>
            <td>{{ entry.location_count }}</td>
            <td>
              {% if entry.primary_location %}
                {{ entry.primary_location.code }}
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              {% if entry.secondary_location %}
                {{ entry.secondary_location.code }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if entry.point_of_use_location %}
                {{ entry.point_of_use_location.code }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ min_stock }}</td>
            <td>
              {% if entry.last_updated %}
                {{ entry.last_updated.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="10">No items match the selected filter.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
<div class="pagination">
  {% if page > 1 %}
    <a href="{{ build_stock_url(page=page-1) }}">Previous</a>
  {% endif %}
  {% if page < pages %}
    <a href="{{ build_stock_url(page=page+1) }}">Next</a>
  {% endif %}
</div>

<script>
  document.querySelectorAll('.clickable-row[data-href]').forEach((row) => {
    row.addEventListener('click', (event) => {
      if (event.target.closest('a, button, input, select, textarea')) {
        return;
      }
      window.location = row.dataset.href;
    });
  });
</script>
{% endblock %}
