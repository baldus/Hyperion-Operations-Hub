{% extends "base.html" %}
{% block content %}
<h2>Stock Transfer (Move)</h2>

<form method="POST" class="form-section move-form" id="move-form" data-lines-url="{{ url_for('inventory.move_location_lines', location_id=0) }}">
  <div class="form-grid move-form-grid">
    <div class="form-field">
      <label class="field-label" for="from-location">From Location</label>
      <select name="from_location_id" id="from-location" required>
        <option value="">Select a source location</option>
        {% for loc in locations %}
          <option value="{{ loc.id }}" {% if loc.id == default_from_location_id %}selected{% endif %}>
            {{ loc.code }}{% if loc.description %} — {{ loc.description }}{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field">
      <label class="field-label" for="to-location">To Location</label>
      <select name="to_location_id" id="to-location" required>
        <option value="">Select a destination location</option>
        {% for loc in locations %}
          <option value="{{ loc.id }}">
            {{ loc.code }}{% if loc.description %} — {{ loc.description }}{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field">
      <label class="field-label" for="reference">Reference</label>
      <input type="text" name="reference" id="reference" value="Stock Transfer">
    </div>

    <div class="form-field">
      <label class="checkbox-inline" for="print-label-after-move">
        <input
          type="checkbox"
          name="print_label_after_move"
          id="print-label-after-move"
          {% if auto_print_default %}checked{% endif %}
        >
        Print label after move
      </label>
    </div>

    <div class="form-field">
      <label class="field-label" for="line-filter">Filter items</label>
      <input type="text" id="line-filter" placeholder="Search SKU, item, or lot">
    </div>
  </div>

  <div class="move-selection-controls">
    <div class="selection-actions">
      <button type="button" class="action-btn secondary" id="select-all">Select all</button>
      <button type="button" class="action-btn secondary" id="clear-selection">Clear selection</button>
    </div>
    <div class="move-summary">
      <div><strong>Selected:</strong> <span id="selected-count">0</span></div>
      <div><strong>Total lines:</strong> <span id="total-lines">0</span></div>
      <div><strong>Total qty:</strong> <span id="total-qty">0</span></div>
    </div>
  </div>

  <div class="table-container move-table">
    <table class="inventory-table">
      <thead>
        <tr>
          <th>
            <span class="sr-only">Select</span>
          </th>
          <th>SKU</th>
          <th>Item</th>
          <th>Lot</th>
          <th>On Hand</th>
          <th>Unit</th>
          <th>Move Qty</th>
        </tr>
      </thead>
      <tbody id="move-lines-body">
        <tr>
          <td colspan="7">Select a source location to load inventory lines.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <input type="hidden" name="lines" id="move-lines-payload">
  <p class="field-note move-validation" id="move-validation" role="status" aria-live="polite"></p>

  <div class="button-row">
    <button type="submit" class="action-btn" id="submit-move" disabled>Submit Transfer</button>
  </div>
</form>

<hr>

<h3>Recent Transfers</h3>
<div class="table-container">
  <table class="inventory-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>SKU</th>
        <th>Item</th>
        <th>Lot / Batch</th>
        <th>Quantity</th>
        <th>Location</th>
        <th>Person</th>
        <th>Reference</th>
        <th>Type</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for rec in records %}
      <tr>
        <td>{{ rec.date.strftime("%Y-%m-%d %H:%M") }}</td>
        <td>{{ items_map[rec.item_id].sku if rec.item_id in items_map else "???" }}</td>
        <td>{{ items_map[rec.item_id].name if rec.item_id in items_map else "Unknown" }}</td>
        <td>{{ batches_map[rec.batch_id].lot_number if rec.batch_id in batches_map else "-" }}</td>
        <td>{{ rec.quantity }}</td>
        <td>{{ locations_map[rec.location_id].code if rec.location_id in locations_map else "-" }}</td>
        <td>{{ rec.person or "-" }}</td>
        <td>{{ rec.reference or "-" }}</td>
        <td>{{ rec.movement_type }}</td>
        <td>
          <form method="post" class="inline-form" action="{{ url_for('inventory.reprint_move_label', movement_id=rec.id) }}">
            <button type="submit" class="action-btn secondary">Reprint label</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_scripts %}
  <script defer src="{{ url_for('static', filename='js/stock-move.js') }}"></script>
{% endblock %}
