{% extends "base.html" %}
{% block content %}
<h2>{{ title }}</h2>
<form method="post" id="bom-form" class="form-stack">
  <section class="form-section">
    <div class="form-grid">
      <label class="form-field">
        <span class="field-label">Template Name</span>
        <input type="text" name="name" value="{{ form_data.name }}" required>
      </label>
      <label class="form-field">
        <span class="field-label">Finished Good Part Number</span>
        <input type="text" name="finished_good_sku" list="item-skus" value="{{ form_data.finished_good_sku }}" required>
        <datalist id="item-skus">
          {% for item in items %}
          <option value="{{ item.sku }}">{{ item.name }}</option>
          {% endfor %}
        </datalist>
      </label>
    </div>
    <label class="form-field">
      <span class="field-label">Description</span>
      <textarea name="description" rows="3">{{ form_data.description }}</textarea>
    </label>
  </section>

  <section class="form-section">
    <div class="section-header">
      <h3>Components</h3>
      <button type="button" class="action-btn" id="add-component">Add Component</button>
    </div>
    <p class="section-help">Specify the component SKU and quantity needed for a single finished good.</p>
    <div class="table-scroll">
      <table class="form-table">
        <thead>
          <tr>
            <th>Component SKU</th>
            <th>Quantity Per</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bom-rows"></tbody>
      </table>
    </div>
  </section>

  <input type="hidden" name="components_json" id="components-json">

  <div class="form-actions">
    <button type="submit" class="action-btn">{{ submit_label }}</button>
    <a href="{{ url_for('inventory.list_boms') }}" class="action-btn secondary">Cancel</a>
  </div>
</form>

<script>
(function() {
  const initialComponents = {{ form_data.components|tojson }};
  const tableBody = document.getElementById('bom-rows');
  const addButton = document.getElementById('add-component');
  const dataInput = document.getElementById('components-json');
  const form = document.getElementById('bom-form');

  function addRow(values = {}) {
    const row = document.createElement('tr');
    row.classList.add('bom-row');
    row.innerHTML = `
      <td>
        <input type="text" class="component-sku" placeholder="Component SKU" list="item-skus" required>
      </td>
      <td>
        <input type="number" class="component-quantity" min="1" placeholder="Qty" required>
      </td>
      <td class="row-actions">
        <button type="button" class="link-btn remove-row">Remove</button>
      </td>
    `;
    const skuInput = row.querySelector('.component-sku');
    const quantityInput = row.querySelector('.component-quantity');
    if (values.sku !== undefined) {
      skuInput.value = values.sku;
    }
    if (values.quantity !== undefined) {
      quantityInput.value = values.quantity;
    }
    row.querySelector('.remove-row').addEventListener('click', () => {
      row.remove();
      syncData();
    });
    tableBody.appendChild(row);
  }

  function syncData() {
    const components = Array.from(tableBody.querySelectorAll('tr')).map(row => {
      const sku = row.querySelector('.component-sku').value.trim();
      const quantity = row.querySelector('.component-quantity').value.trim();
      return { sku, quantity };
    }).filter(component => component.sku !== '');
    dataInput.value = JSON.stringify(components);
  }

  addButton.addEventListener('click', () => {
    addRow();
  });

  form.addEventListener('submit', () => {
    syncData();
  });

  if (initialComponents && initialComponents.length) {
    initialComponents.forEach(component => addRow(component));
  } else {
    addRow();
  }
})();
</script>
{% endblock %}
