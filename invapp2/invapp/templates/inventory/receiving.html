{% extends "base.html" %}
{% block content %}
{% set defaults = form_defaults or {} %}
<h2>Receiving</h2>

<section class="card">
  <h3>Item Lookup</h3>
  <p>Search by item name or SKU, then apply the result to the form.</p>
  <div class="form-row">
    <input type="text" id="item-lookup-query" placeholder="Search items...">
    <button type="button" id="item-lookup-btn" class="bubble-btn">Search</button>
  </div>
  <div id="item-lookup-results" class="table-container" aria-live="polite"></div>
</section>

<form method="POST">
  <label>SKU:</label><br>
  <input type="text" name="sku" value="{{ defaults.get('sku', '') }}" required><br><br>

  <label>Quantity:</label><br>
  <input type="number" name="qty" value="{{ defaults.get('qty', '') }}" required><br><br>

  {% if can_defer_without_qty %}
  <div class="form-row">
    <input type="checkbox" id="defer_qty" name="defer_qty" value="1">
    <label for="defer_qty">Receive without quantity (add it later)</label>
  </div>
  <p class="form-hint">Creates the receiving record with zero quantity so the final count can be added afterward.</p>
  <br>
  {% endif %}

  <label>Location:</label><br>
  <select name="location_id" required>
    {% for loc in locations %}
      {% set selected = 'selected' if defaults.get('location_id') == loc.id|string else '' %}
      <option value="{{ loc.id }}" {{ selected }}>{{ loc.code }}</option>
    {% endfor %}
  </select><br><br>

  {% if default_location %}
    <p id="default-location-display" class="form-hint">Default location: {{ default_location.code }}{% if default_location.description %} ({{ default_location.description }}){% endif %}</p>
  {% elif defaults.get('sku') %}
    <p id="default-location-display" class="form-hint">No default location set for this SKU.</p>
  {% else %}
    <p id="default-location-display" class="form-hint">Enter a SKU to see its default location.</p>
  {% endif %}

  <label>Person Receiving:</label><br>
  <input type="text" name="person" value="{{ defaults.get('person', '') }}" required><br><br>

  <label>PO Number (optional):</label><br>
  <input type="text" name="po_number" value="{{ defaults.get('po_number', '') }}"><br><br>

  <button type="submit" class="bubble-btn">Submit</button>
</form>

<hr>

<h3>Recent Receipts</h3>
<div class="table-container">
  <table class="inventory-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>SKU</th>
        <th>Item</th>
        <th>Lot / Batch</th>
        <th>Quantity</th>
        <th>Location</th>
        <th>Person</th>
        <th>PO Number</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for rec in records %}
      <tr>
        <td>{{ rec.date.strftime("%Y-%m-%d %H:%M") }}</td>
        <td>{{ rec.item.sku if rec.item else "???" }}</td>
        <td>{{ rec.item.name if rec.item else "Unknown" }}</td>
        <td>{{ rec.batch.lot_number if rec.batch else "-" }}</td>
        <td>{{ rec.quantity }}</td>
        <td>{{ rec.location.code if rec.location else "-" }}</td>
        <td>{{ rec.person or "-" }}</td>
        <td>{{ rec.po_number or "-" }}</td>
        <td>
          <form method="post" action="{{ url_for('inventory.reprint_receiving_label', receipt_id=rec.id) }}">
            <button type="submit" class="bubble-btn">Reprint Label</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const skuInput = document.querySelector('input[name="sku"]');
    const qtyInput = document.querySelector('input[name="qty"]');
    const deferCheckbox = document.getElementById('defer_qty');
    const lookupInput = document.getElementById('item-lookup-query');
    const lookupButton = document.getElementById('item-lookup-btn');
    const lookupResults = document.getElementById('item-lookup-results');
    const defaultLocationDisplay = document.getElementById('default-location-display');
    const locationSelect = document.querySelector('select[name="location_id"]');

    if (qtyInput && deferCheckbox) {
      const syncQtyState = () => {
        if (deferCheckbox.checked) {
          qtyInput.required = false;
          qtyInput.placeholder = 'Quantity will be entered later';
          qtyInput.value = '';
        } else {
          qtyInput.required = true;
          qtyInput.placeholder = '';
        }
      };

      deferCheckbox.addEventListener('change', syncQtyState);
      syncQtyState();
    }

    const renderLookupResults = (items) => {
      if (!Array.isArray(items) || !items.length) {
        lookupResults.innerHTML = '<p>No items found. Try a different search.</p>';
        return;
      }

      const rows = items.map(item => `
        <tr>
          <td>${item.sku}</td>
          <td>${item.name || ''}</td>
          <td><button type="button" class="bubble-btn use-sku" data-sku="${item.sku}">Use SKU</button></td>
        </tr>
      `).join('');

      lookupResults.innerHTML = `
        <table class="inventory-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      lookupResults.querySelectorAll('.use-sku').forEach((btn) => {
        btn.addEventListener('click', (event) => {
          const sku = event.currentTarget.getAttribute('data-sku');
          if (skuInput) {
            skuInput.value = sku;
            skuInput.focus();
            lookupDefaultLocation();
          }
        });
      });
    };

    const setDefaultLocationMessage = (message) => {
      if (defaultLocationDisplay) {
        defaultLocationDisplay.textContent = message;
      }
    };

    const applyDefaultLocation = (location) => {
      if (!defaultLocationDisplay) return;

      if (location && location.code) {
        const extra = location.description ? ` (${location.description})` : '';
        defaultLocationDisplay.textContent = `Default location: ${location.code}${extra}`;
        if (locationSelect && location.id !== undefined && location.id !== null) {
          locationSelect.value = String(location.id);
        }
      } else {
        setDefaultLocationMessage('No default location set for this SKU.');
      }
    };

    const lookupDefaultLocation = async () => {
      if (!skuInput) return;
      const sku = (skuInput.value || '').trim();
      if (!sku) {
        setDefaultLocationMessage('Enter a SKU to see its default location.');
        return;
      }

      try {
        const response = await fetch(`/inventory/api/items/${encodeURIComponent(sku)}`);
        if (!response.ok) {
          setDefaultLocationMessage('Item not found. Please verify the SKU.');
          return;
        }
        const data = await response.json();
        applyDefaultLocation(data.default_location);
      } catch (error) {
        setDefaultLocationMessage('Unable to load default location right now.');
      }
    };

    const performLookup = async () => {
      const query = (lookupInput?.value || '').trim();
      if (!query) {
        lookupResults.innerHTML = '<p>Please enter a search term.</p>';
        return;
      }

      lookupResults.innerHTML = '<p>Searchingâ€¦</p>';
      try {
        const response = await fetch(`/inventory/api/items/search?q=${encodeURIComponent(query)}`);
        if (!response.ok) {
          lookupResults.innerHTML = '<p>Search failed. Please try again.</p>';
          return;
        }
        const data = await response.json();
        renderLookupResults(data.results || []);
      } catch (error) {
        lookupResults.innerHTML = '<p>Unable to search right now. Please try again.</p>';
      }
    };

    lookupButton?.addEventListener('click', performLookup);
    lookupInput?.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        performLookup();
      }
    });

    skuInput?.addEventListener('change', lookupDefaultLocation);
    skuInput?.addEventListener('blur', lookupDefaultLocation);
    skuInput?.addEventListener('input', (event) => {
      if (!event.target.value) {
        setDefaultLocationMessage('Enter a SKU to see its default location.');
      }
    });
  });
</script>
{% endblock %}
