{% extends "base.html" %}
{% block content %}
<h2>Map Physical Inventory Columns</h2>
<p class="field-note">
  Select the upload columns and Item fields used to match ERP totals to existing Items.
  Item Name matching is required and should align with the ERP export.
</p>
<form method="POST" id="physical-inventory-form">
  <input type="hidden" name="step" value="mapping">
  <input type="hidden" name="import_token" value="{{ import_token|e }}">
  <input type="hidden" name="source_filename" value="{{ source_filename|e }}">

  <div class="table-responsive mb-4">
    <table class="table table-sm align-middle">
      <tbody>
        <tr>
          <th>Upload column for Item Name *</th>
          <td>
            <select name="primary_upload_column" class="form-select" required>
              <option value="">Select column</option>
              {% for header in headers %}
              <option value="{{ header }}" {% if selected_mappings.get('item_name') == header %}selected{% endif %}>{{ header }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <th>Item DB field to match against *</th>
          <td>
            <select name="primary_item_field" class="form-select" id="primary-item-field" required>
              <option value="">Select field</option>
              {% for field in item_fields %}
              <option value="{{ field.name }}" {% if selected_primary_item_field == field.name %}selected{% endif %}>
                Item.{{ field.name }}
              </option>
              {% endfor %}
            </select>
            <div class="field-note mt-2">
              Matching is exact on the normalized value. SKU fields are intentionally excluded.
            </div>
          </td>
        </tr>
        <tr>
          <th>Optional secondary upload column</th>
          <td>
            <select name="secondary_upload_column" class="form-select">
              <option value="">None</option>
              {% for header in headers %}
              <option value="{{ header }}" {% if selected_mappings.get('description') == header %}selected{% endif %}>{{ header }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <th>Optional secondary Item field</th>
          <td>
            <select name="secondary_item_field" class="form-select">
              <option value="">None</option>
              {% for field in item_fields %}
              <option value="{{ field.name }}" {% if selected_secondary_item_field == field.name %}selected{% endif %}>
                Item.{{ field.name }}
              </option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <th>Quantity column *</th>
          <td>
            <select name="quantity_column" class="form-select" required>
              <option value="">Select column</option>
              {% for header in headers %}
              <option value="{{ header }}" {% if selected_mappings.get('quantity') == header %}selected{% endif %}>{{ header }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <th>Duplicate Item Names</th>
          <td>
            <select name="duplicate_strategy" class="form-select">
              {% for key, label in duplicate_strategies.items() %}
              <option value="{{ key }}" {% if duplicate_strategy == key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <div class="field-note mt-2">
              Default behavior sums duplicate quantities into one snapshot line.
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Normalization Options</h3>
  <div class="mb-4">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="trim_whitespace" id="trim_whitespace" {% if options.trim_whitespace %}checked{% endif %}>
      <label class="form-check-label" for="trim_whitespace">Trim whitespace</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="case_insensitive" id="case_insensitive" {% if options.case_insensitive %}checked{% endif %}>
      <label class="form-check-label" for="case_insensitive">Case-insensitive</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="remove_spaces" id="remove_spaces" {% if options.remove_spaces %}checked{% endif %}>
      <label class="form-check-label" for="remove_spaces">Remove spaces</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="remove_dashes_underscores" id="remove_dashes_underscores" {% if options.remove_dashes_underscores %}checked{% endif %}>
      <label class="form-check-label" for="remove_dashes_underscores">Remove dashes/underscores</label>
    </div>
  </div>

  <div class="mb-4">
    <button type="button" class="btn btn-outline-primary" id="test-matching">Test Matching</button>
    <button type="submit" class="btn btn-primary">Create Snapshot</button>
    <a href="{{ url_for('inventory.physical_inventory_import') }}" class="btn btn-secondary">Start Over</a>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h4>Create Missing Items</h4>
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" name="create_missing_items" id="create_missing_items" {% if create_missing_items %}checked{% endif %}>
        <label class="form-check-label" for="create_missing_items">
          Create missing items from unmatched rows (superuser only)
        </label>
      </div>
      <p class="small text-muted mb-0">
        When enabled, unmatched rows with missing Items will be created before importing ERP totals.
      </p>
    </div>
  </div>

  <div class="card mb-4" id="matching-results" style="display:none;">
    <div class="card-body">
      <h4>Match Preview</h4>
      <p id="match-summary" class="mb-2"></p>
      <div class="row">
        <div class="col-md-6">
          <h5>Missing Item Samples</h5>
          <ul id="missing-item-samples" class="small text-muted"></ul>
          <h5 class="mt-3">Missing Value Samples</h5>
          <ul id="missing-value-samples" class="small text-muted"></ul>
        </div>
        <div class="col-md-6">
          <h5>Ambiguous Samples</h5>
          <ul id="ambiguous-samples" class="small text-muted"></ul>
        </div>
      </div>
      <div class="mt-3" id="create-items-preview" style="display:none;">
        <h5>Items to Create</h5>
        <p class="small text-muted" id="create-items-count"></p>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Description</th>
                <th id="secondary-field-header" style="display:none;"></th>
              </tr>
            </thead>
            <tbody id="create-items-body"></tbody>
          </table>
        </div>
      </div>
      <div class="mt-3">
        <strong>Fields Used:</strong>
        <span id="fields-used" class="small text-muted"></span>
      </div>
    </div>
  </div>

  <div class="card mb-4" id="field-samples" style="display:none;">
    <div class="card-body">
      <h4>Sample Item Field Values</h4>
      <p class="small text-muted">First 20 distinct values from the selected Item field.</p>
      <ul id="field-sample-list" class="small text-muted"></ul>
    </div>
  </div>

  <h3>Preview (first 50 rows)</h3>
  <div class="table-responsive">
    <table class="table table-bordered table-sm">
      <thead>
        <tr>
          {% for header in headers %}
          <th>{{ header }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% if sample_rows %}
          {% for row in sample_rows %}
          <tr>
            {% for cell in row %}
            <td>{{ cell }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="{{ headers|length or 1 }}" class="text-muted">No sample data found in the uploaded file.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    const form = document.getElementById('physical-inventory-form');
    const testBtn = document.getElementById('test-matching');
    const resultsCard = document.getElementById('matching-results');
    const matchSummary = document.getElementById('match-summary');
    const missingItemList = document.getElementById('missing-item-samples');
    const missingValueList = document.getElementById('missing-value-samples');
    const ambiguousList = document.getElementById('ambiguous-samples');
    const fieldsUsed = document.getElementById('fields-used');
    const fieldSelect = document.getElementById('primary-item-field');
    const fieldSamplesCard = document.getElementById('field-samples');
    const fieldSampleList = document.getElementById('field-sample-list');
    const createMissingItemsToggle = document.getElementById('create_missing_items');
    const createItemsPreview = document.getElementById('create-items-preview');
    const createItemsCount = document.getElementById('create-items-count');
    const createItemsBody = document.getElementById('create-items-body');
    const secondaryFieldHeader = document.getElementById('secondary-field-header');

    function clearList(el) {
      while (el.firstChild) {
        el.removeChild(el.firstChild);
      }
    }

    function appendList(el, items) {
      clearList(el);
      if (!items || items.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No rows.';
        el.appendChild(li);
        return;
      }
      items.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        el.appendChild(li);
      });
    }

    function renderCreateItems(items, totalCount) {
      clearList(createItemsBody);
      if (!items || items.length === 0) {
        createItemsPreview.style.display = 'none';
        return;
      }
      items.forEach((item) => {
        const tr = document.createElement('tr');
        const nameCell = document.createElement('td');
        nameCell.textContent = item.name || '';
        const descCell = document.createElement('td');
        descCell.textContent = item.description || '';
        tr.appendChild(nameCell);
        tr.appendChild(descCell);
        if (item.secondary_field_label) {
          secondaryFieldHeader.textContent = item.secondary_field_label;
          secondaryFieldHeader.style.display = '';
          const secondaryCell = document.createElement('td');
          secondaryCell.textContent = item.secondary_field_value || '';
          tr.appendChild(secondaryCell);
        } else {
          secondaryFieldHeader.style.display = 'none';
        }
        createItemsBody.appendChild(tr);
      });
      createItemsCount.textContent = `${totalCount} item${totalCount === 1 ? '' : 's'} will be created if enabled.`;
      createItemsPreview.style.display = createMissingItemsToggle && createMissingItemsToggle.checked ? 'block' : 'none';
    }

    function fetchFieldSamples() {
      const field = fieldSelect.value;
      if (!field) {
        fieldSamplesCard.style.display = 'none';
        return;
      }
      fetch(`{{ url_for('inventory.physical_inventory_field_samples') }}?field=${encodeURIComponent(field)}`)
        .then((response) => response.json())
        .then((data) => {
          const samples = data.samples || [];
          appendList(fieldSampleList, samples.length ? samples : ['No sample values found.']);
          fieldSamplesCard.style.display = 'block';
        })
        .catch(() => {
          fieldSamplesCard.style.display = 'none';
        });
    }

    if (fieldSelect) {
      fieldSelect.addEventListener('change', fetchFieldSamples);
      fetchFieldSamples();
    }

    testBtn.addEventListener('click', function () {
      const formData = new FormData(form);
      const payload = {
        import_token: formData.get('import_token'),
        primary_upload_column: formData.get('primary_upload_column'),
        primary_item_field: formData.get('primary_item_field'),
        secondary_upload_column: formData.get('secondary_upload_column'),
        secondary_item_field: formData.get('secondary_item_field'),
        quantity_column: formData.get('quantity_column'),
        trim_whitespace: formData.get('trim_whitespace') === 'on',
        case_insensitive: formData.get('case_insensitive') === 'on',
        remove_spaces: formData.get('remove_spaces') === 'on',
        remove_dashes_underscores: formData.get('remove_dashes_underscores') === 'on'
      };

      fetch('{{ url_for('inventory.physical_inventory_test_matching') }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          matchSummary.textContent = data.error;
          resultsCard.style.display = 'block';
          return;
        }
        matchSummary.textContent = `Match rate: ${data.match_rate.toFixed(1)}% | Matched: ${data.matched_count} | Unmatched: ${data.unmatched_count} | Ambiguous: ${data.ambiguous_count}`;

        appendList(missingItemList, (data.missing_item_rows || []).map((row) => {
          return `Row ${row.row_index}: ${row.reason}`;
        }));

        appendList(missingValueList, (data.missing_value_rows || []).map((row) => {
          return `Row ${row.row_index}: ${row.reason}`;
        }));

        appendList(ambiguousList, (data.ambiguous_rows || []).map((row) => {
          return `Row ${row.row_index}: ${row.reason}`;
        }));

        const createItems = data.missing_item_candidates || {};
        renderCreateItems(createItems.preview || [], createItems.count || 0);

        const fields = data.fields_used || {};
        fieldsUsed.textContent = `Upload column: ${fields.primary_upload_column} → Item.${fields.primary_item_field}` + (fields.secondary_upload_column ? ` (secondary: ${fields.secondary_upload_column} → Item.${fields.secondary_item_field})` : '') + ` | Quantity: ${fields.quantity_column}`;
        resultsCard.style.display = 'block';
      })
      .catch(() => {
        matchSummary.textContent = 'Unable to run matching preview.';
        resultsCard.style.display = 'block';
      });
    });

    if (createMissingItemsToggle) {
      createMissingItemsToggle.addEventListener('change', function () {
        if (createMissingItemsToggle.checked && createItemsBody.childElementCount > 0) {
          createItemsPreview.style.display = 'block';
        } else {
          createItemsPreview.style.display = 'none';
        }
      });
    }
  })();
</script>
{% endblock %}
