{% extends "base.html" %}
{% block content %}
{% set show_orders = order_summary is not none %}
{% set show_inventory = inventory_summary is not none %}

<h2>Hyperion Operations Overview</h2>
<p class="home-lede">Stay ahead of production promises and inventory risks with the highlights below.</p>

{% if not current_user.is_authenticated %}
<p class="home-summary-note">
  You are viewing a public, read-only snapshot of current shop activity.
  <a class="home-summary-link" href="{{ login_url }}">Log In</a> to update data or run jobs.
</p>
{% elif not (can_manage_orders or can_manage_inventory) %}
<p class="home-summary-note">
  Your account can view dashboard information but cannot make changes. Contact an administrator if you need additional access.
</p>
{% endif %}

{% if show_orders or show_inventory %}
<div class="home-summary-grid">
  {% if show_orders %}
  <section class="home-summary-card">
    <div class="home-summary-heading">
      <h3>Orders</h3>
      <span class="home-summary-badge">Production</span>
    </div>
    <div class="home-summary-metrics">
      <p class="home-summary-metric"><strong>{{ order_summary.due_soon_count }}</strong> due within {{ order_summary.due_soon_window_days }} days</p>
      <p class="home-summary-metric"><strong>{{ order_summary.waiting_material_count }}</strong> waiting on material</p>
    </div>
    {% if order_summary.overdue_count %}
    <p class="home-summary-alert">⚠️ {{ order_summary.overdue_count }} orders are overdue</p>
    {% endif %}

    <h4 class="home-summary-subheading">Next due</h4>
    <ul class="home-summary-list">
      {% for order in order_summary.due_soon_preview %}
      <li>
        <div class="home-summary-line">
          <a href="{{ url_for('orders.view_order', order_id=order.id) }}" class="home-summary-primary">{{ order.order_number }}</a>
          <span class="home-summary-meta">Due {{ order.promised_date.strftime('%b %d, %Y') }}</span>
        </div>
        <div class="home-summary-line">
          <span class="home-summary-secondary">{{ order.customer_name or 'Internal' }}</span>
          <span class="home-summary-status">{{ order.status_label }}</span>
        </div>
      </li>
      {% else %}
      <li class="home-summary-empty">No orders are due in the next {{ order_summary.due_soon_window_days }} days.</li>
      {% endfor %}
    </ul>
    {% if order_summary.due_soon_count > order_summary.due_soon_preview|length %}
    <p class="home-summary-note">Showing the first {{ order_summary.preview_limit }} upcoming due dates.</p>
    {% endif %}

    {% if order_summary.overdue_preview %}
    <h4 class="home-summary-subheading">Overdue</h4>
    <ul class="home-summary-list">
      {% for order in order_summary.overdue_preview %}
      <li class="home-summary-critical">
        <div class="home-summary-line">
          <a href="{{ url_for('orders.view_order', order_id=order.id) }}" class="home-summary-primary">{{ order.order_number }}</a>
          <span class="home-summary-meta">Due {{ order.promised_date.strftime('%b %d, %Y') }}</span>
        </div>
        <div class="home-summary-line">
          <span class="home-summary-status">{{ order.status_label }}</span>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% if order_summary.overdue_count > order_summary.overdue_preview|length %}
    <p class="home-summary-note">Showing the first {{ order_summary.preview_limit }} overdue orders.</p>
    {% endif %}
    {% endif %}

    <div class="home-summary-footer">
      {% if can_manage_orders %}
      <a class="home-summary-link" href="{{ url_for('orders.orders_home') }}">Go to Orders →</a>
      {% elif current_user.is_authenticated %}
      <span class="home-summary-note">You do not have permission to manage orders.</span>
      {% else %}
      <a class="home-summary-link" href="{{ login_orders_url }}">Log In to manage orders →</a>
      {% endif %}
    </div>
  </section>
  {% endif %}

  {% if show_inventory %}
  <section class="home-summary-card">
    <div class="home-summary-heading">
      <h3>Inventory</h3>
      <span class="home-summary-badge">Stock Control</span>
    </div>
    <div class="home-summary-metrics">
      <p class="home-summary-metric"><strong>{{ inventory_summary.out_count }}</strong> out of stock</p>
      <p class="home-summary-metric"><strong>{{ inventory_summary.low_count }}</strong> below minimum (stock remaining)</p>
    </div>

    <h4 class="home-summary-subheading">Items to review</h4>
    <ul class="home-summary-list">
      {% for entry in inventory_summary.preview %}
      <li {% if entry.is_out %}class="home-summary-critical"{% endif %}>
        <div class="home-summary-line">
          <span class="home-summary-primary">{{ entry.item.sku }}</span>
          {% if entry.is_out %}
          <span class="home-summary-meta">Out of stock &middot; Min {{ entry.min_stock }}</span>
          {% else %}
          <span class="home-summary-meta">{{ entry.on_hand }} on hand &middot; Min {{ entry.min_stock }}</span>
          {% endif %}
        </div>
        <div class="home-summary-line">
          <span class="home-summary-secondary">{{ entry.item.name or 'Unnamed item' }}</span>
        </div>
      </li>
      {% else %}
      <li class="home-summary-empty">All monitored items are above their minimum levels.</li>
      {% endfor %}
    </ul>
    {% if inventory_summary.total_alerts > inventory_summary.preview|length %}
    <p class="home-summary-note">Showing the {{ inventory_summary.preview_limit }} most urgent items.</p>
    {% endif %}

    <div class="home-summary-footer">
      {% if can_manage_inventory %}
      <a class="home-summary-link" href="{{ url_for('inventory.inventory_home') }}">Go to Inventory →</a>
      {% elif current_user.is_authenticated %}
      <span class="home-summary-note">You do not have permission to manage inventory.</span>
      {% else %}
      <a class="home-summary-link" href="{{ login_inventory_url }}">Log In to manage inventory →</a>
      {% endif %}
    </div>
  </section>
  {% endif %}
</div>
{% else %}
<p class="home-summary-empty">No order or inventory highlights are available yet. Check back soon as data is added.</p>
{% endif %}
{% endblock %}
