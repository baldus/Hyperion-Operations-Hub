{% extends "base.html" %}
{% block content %}
<h2>Hyperion Operations Overview</h2>
{% if not database_online %}
<div class="home-alert" role="alert">
  <h3 class="home-alert-title">Database connection unavailable</h3>
  {% if database_error_message %}
  <p class="home-alert-message">{{ database_error_message }}</p>
  {% else %}
  <p class="home-alert-message">The operations console is running without a live database connection. Dashboards and write actions are temporarily unavailable.</p>
  {% endif %}
  <p class="home-alert-message">Restore connectivity and relaunch the service to resume normal operation.</p>
  {% if database_recovery_steps %}
  <details class="home-alert-details">
    <summary>Suggested recovery steps</summary>
    <ol>
      {% for step in database_recovery_steps %}
      <li>
        <strong>{{ step.title }}:</strong>
        <code>{{ step.command }}</code>
      </li>
      {% endfor %}
    </ol>
  </details>
  {% endif %}
  {% if emergency_access_active %}
  <p class="home-alert-message">
    You're using emergency offline access. Open the <a href="{{ url_for('admin.tools') }}">admin tools</a> or launch the
    <a href="{{ url_for('admin.emergency_console') }}">emergency command console</a> to restart PostgreSQL, rebuild the
    database, or reinstall dependencies directly from the browser.
  </p>
  {% endif %}
</div>
{% endif %}
{% if not current_user.is_authenticated %}
<p class="home-lede">You're viewing the public dashboard. Log in with your assigned account to make updates or see additional pages.</p>
{% else %}
<p class="home-lede">Stay ahead of production promises and inventory risks with the highlights below.</p>
{% endif %}

{% set show_orders = order_summary is not none %}
{% set show_inventory = inventory_summary is not none %}

{% if show_orders or show_inventory %}
<div class="home-summary-grid">
  {% if show_orders %}
  <section class="home-summary-card">
    <div class="home-summary-heading">
      <h3>Orders</h3>
      <span class="home-summary-badge">Production</span>
    </div>
    <div class="home-summary-metrics">
      <p class="home-summary-metric"><strong>{{ order_summary.due_soon_count }}</strong> due within {{ order_summary.due_soon_window_days }} days</p>
      <p class="home-summary-metric"><strong>{{ order_summary.waiting_material_count }}</strong> waiting on material</p>
    </div>
    {% if order_summary.overdue_count %}
    <p class="home-summary-alert">⚠️ {{ order_summary.overdue_count }} orders are overdue</p>
    {% endif %}

    <h4 class="home-summary-subheading">Next due</h4>
    <ul class="home-summary-list">
      {% for order in order_summary.due_soon_preview %}
      <li>
        <div class="home-summary-line">
          <a href="{{ url_for('orders.view_order', order_id=order.id) }}" class="home-summary-primary">{{ order.order_number }}</a>
          <span class="home-summary-meta">Due {{ order.promised_date.strftime('%b %d, %Y') }}</span>
        </div>
        <div class="home-summary-line">
          <span class="home-summary-secondary">{{ order.customer_name or 'Internal' }}</span>
          <span class="home-summary-status">{{ order.status_label }}</span>
        </div>
      </li>
      {% else %}
      <li class="home-summary-empty">No orders are due in the next {{ order_summary.due_soon_window_days }} days.</li>
      {% endfor %}
    </ul>
    {% if order_summary.due_soon_count > order_summary.due_soon_preview|length %}
    <p class="home-summary-note">Showing the first {{ order_summary.preview_limit }} upcoming due dates.</p>
    {% endif %}

    {% if order_summary.overdue_preview %}
    <h4 class="home-summary-subheading">Overdue</h4>
    <ul class="home-summary-list">
      {% for order in order_summary.overdue_preview %}
      <li class="home-summary-critical">
        <div class="home-summary-line">
          <a href="{{ url_for('orders.view_order', order_id=order.id) }}" class="home-summary-primary">{{ order.order_number }}</a>
          <span class="home-summary-meta">Due {{ order.promised_date.strftime('%b %d, %Y') }}</span>
        </div>
        <div class="home-summary-line">
          <span class="home-summary-status">{{ order.status_label }}</span>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% if order_summary.overdue_count > order_summary.overdue_preview|length %}
    <p class="home-summary-note">Showing the first {{ order_summary.preview_limit }} overdue orders.</p>
    {% endif %}
    {% endif %}

    <div class="home-summary-footer">
      <a class="home-summary-link" href="{{ url_for('orders.orders_home') }}">Go to Orders →</a>
    </div>
  </section>
  {% endif %}

  {% if show_inventory %}
  <section class="home-summary-card">
    <div class="home-summary-heading">
      <h3>Inventory</h3>
      <span class="home-summary-badge">Stock Control</span>
    </div>
    <div class="home-summary-metrics">
      <p class="home-summary-metric"><strong>{{ inventory_summary.out_count }}</strong> out of stock</p>
      <p class="home-summary-metric"><strong>{{ inventory_summary.low_count }}</strong> below minimum (stock remaining)</p>
    </div>

    <h4 class="home-summary-subheading">Items to review</h4>
    <ul class="home-summary-list">
      {% for entry in inventory_summary.preview %}
      <li {% if entry.is_out %}class="home-summary-critical"{% endif %}>
        <div class="home-summary-line">
          <span class="home-summary-primary">{{ entry.item.sku }}</span>
          {% if entry.is_out %}
          <span class="home-summary-meta">Out of stock &middot; Min {{ entry.min_stock }}</span>
          {% else %}
          <span class="home-summary-meta">{{ entry.on_hand }} on hand &middot; Min {{ entry.min_stock }}</span>
          {% endif %}
        </div>
        <div class="home-summary-line">
          <span class="home-summary-secondary">{{ entry.item.name or 'Unnamed item' }}</span>
        </div>
      </li>
      {% else %}
      <li class="home-summary-empty">All monitored items are above their minimum levels.</li>
      {% endfor %}
    </ul>
    {% if inventory_summary.total_alerts > inventory_summary.preview|length %}
    <p class="home-summary-note">Showing the {{ inventory_summary.preview_limit }} most urgent items.</p>
    {% endif %}

    <div class="home-summary-footer">
      <a class="home-summary-link" href="{{ url_for('inventory.inventory_home') }}">Go to Inventory →</a>
    </div>
  </section>
  {% endif %}
</div>
{% else %}
<p class="home-summary-empty">No operational summaries are available for your role yet. Use the navigation menu to explore the areas available to you.</p>
{% endif %}

{% if not current_user.is_authenticated %}
<p class="home-summary-note">Need to make changes? <a href="{{ url_for('auth.login') }}">Log in</a> with your company credentials.</p>
{% endif %}

{% if useful_links %}
<section class="home-links">
  <div class="home-links__header">
    <h3>Useful Links</h3>
    {% if is_superuser() %}
    <a class="home-summary-link" href="{{ url_for('useful_links.manage_links') }}">Edit links</a>
    {% endif %}
  </div>
  <ul class="home-links-list">
    {% for link in useful_links %}
    <li class="home-link-card">
      <h4 class="home-link-title"><a href="{{ link.url }}" target="_blank" rel="noreferrer noopener">{{ link.title }}</a></h4>
      {% if link.description %}
      <p class="home-link-description">{{ link.description }}</p>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</section>
{% elif is_superuser() %}
<section class="home-links">
  <div class="home-links__header">
    <h3>Useful Links</h3>
    <a class="home-summary-link" href="{{ url_for('useful_links.manage_links') }}">Add links</a>
  </div>
  <p class="home-summary-note">Add links so your team can quickly reach external resources.</p>
</section>
{% endif %}
{% endblock %}
