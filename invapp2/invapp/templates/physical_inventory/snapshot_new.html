{% extends "base.html" %}
{% block content %}
<h2>Create Physical Inventory Snapshot</h2>

<p class="field-note">Upload ERP system totals (no locations). The snapshot will generate count lines for known item-location pairs.</p>

<form method="post" enctype="multipart/form-data" class="stacked-form">
  <label for="name">Snapshot Name (optional)
    <input id="name" name="name" type="text" placeholder="Q1 2025 Cycle Count">
  </label>
  <label for="snapshot_date">Snapshot Date (optional)
    <input id="snapshot_date" name="snapshot_date" type="date">
  </label>
  <label for="source">Source (optional)
    <input id="source" name="source" type="text" placeholder="CSV / Sage">
  </label>
  <label for="snapshot_csv">Snapshot CSV
    <input id="snapshot_csv" name="snapshot_csv" type="file" accept=".csv" required>
  </label>
  <details>
    <summary>Optional: Map CSV columns manually</summary>
    <p class="field-note">Use this when your CSV headers do not match the expected names. Enter the exact header text from your file.</p>
    {% if uploaded_headers %}
    <p class="field-note">Detected headers: {{ uploaded_headers | join(', ') }}</p>
    <datalist id="snapshot-header-options">
      {% for header in uploaded_headers %}
      <option value="{{ header }}"></option>
      {% endfor %}
    </datalist>
    {% endif %}
    <label for="item_code_column">Item code column
      <input id="item_code_column" name="item_code_column" type="text" list="snapshot-header-options" value="{{ column_mapping.get('item_code', '') if column_mapping else '' }}" placeholder="item_code">
    </label>
    <label for="system_total_qty_column">System total qty column
      <input id="system_total_qty_column" name="system_total_qty_column" type="text" list="snapshot-header-options" value="{{ column_mapping.get('system_total_qty', '') if column_mapping else '' }}" placeholder="system_total_qty">
    </label>
    <label for="uom_column">UOM column (optional)
      <input id="uom_column" name="uom_column" type="text" list="snapshot-header-options" value="{{ column_mapping.get('uom', '') if column_mapping else '' }}" placeholder="uom">
    </label>
    <label for="description_column">Description column (optional)
      <input id="description_column" name="description_column" type="text" list="snapshot-header-options" value="{{ column_mapping.get('description', '') if column_mapping else '' }}" placeholder="description">
    </label>
    <label for="notes_column">Notes column (optional)
      <input id="notes_column" name="notes_column" type="text" list="snapshot-header-options" value="{{ column_mapping.get('notes', '') if column_mapping else '' }}" placeholder="notes">
    </label>
  </details>
  <div class="form-row">
    <button type="submit" class="action-btn">Upload Snapshot</button>
  </div>
</form>

<div class="dashboard-section">
  <h3>Required CSV Headers</h3>
  <ul>
    {% for header in required_headers %}
    <li><code>{{ header }}</code></li>
    {% endfor %}
  </ul>
  <p class="field-note">Optional headers: <code>uom</code>, <code>description</code>, <code>notes</code>.</p>
  <p class="field-note">Header aliases are accepted (example: <code>sku</code> for <code>item_code</code>, <code>qty</code> for <code>system_total_qty</code>).</p>
  <p class="field-note">If headers still do not match, use the manual mapping section above to match columns explicitly.</p>
</div>
{% endblock %}
