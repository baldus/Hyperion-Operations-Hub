{% extends "base.html" %}

{% block content %}
<h2>Preview Open Orders Import</h2>
<p><strong>File:</strong> {{ filename }}</p>

<div class="content-card">
    <h3>Summary</h3>
    <ul>
        <li><strong>New lines:</strong> {{ diff.new_keys | length }}</li>
        <li><strong>Still open lines:</strong> {{ diff.still_open_keys | length }}</li>
        <li><strong>Completed lines:</strong> {{ diff.completed_keys | length }}</li>
        <li><strong>Changed lines:</strong> {{ diff.changed_rows | length }}</li>
    </ul>
</div>

<h3>New Lines</h3>
{% if new_lines %}
<table class="data-table">
    <thead>
        <tr>
            <th>SO No</th>
            <th>Customer</th>
            <th>Item</th>
            <th>Description</th>
            <th>Qty Remaining</th>
            <th>Ship By</th>
        </tr>
    </thead>
    <tbody>
        {% for row in new_lines %}
        <tr>
            <td>{{ row.so_no }}</td>
            <td>{{ row.customer_name }}</td>
            <td>{{ row.item_id }}</td>
            <td>{{ row.line_description }}</td>
            <td>{{ row.qty_remaining }}</td>
            <td>{{ row.ship_by or '' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No new lines.</p>
{% endif %}

<h3>Changed Lines</h3>
{% if diff.changed_rows %}
<table class="data-table">
    <thead>
        <tr>
            <th>SO No</th>
            <th>Item</th>
            <th>Description</th>
            <th>Changes</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in diff.changed_rows %}
        <tr>
            <td>{{ entry.current.so_no }}</td>
            <td>{{ entry.current.item_id }}</td>
            <td>{{ entry.current.line_description }}</td>
            <td>
                <ul>
                    {% for change in entry.changes %}
                    <li>{{ change.field }}: {{ change.before }} â†’ {{ change.after }}</li>
                    {% endfor %}
                </ul>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No changes detected.</p>
{% endif %}

<h3>Still Open Lines</h3>
{% if still_open_lines %}
<table class="data-table">
    <thead>
        <tr>
            <th>SO No</th>
            <th>Customer</th>
            <th>Item</th>
            <th>Description</th>
            <th>Qty Remaining</th>
            <th>Ship By</th>
        </tr>
    </thead>
    <tbody>
        {% for row in still_open_lines %}
        <tr>
            <td>{{ row.so_no }}</td>
            <td>{{ row.customer_name }}</td>
            <td>{{ row.item_id }}</td>
            <td>{{ row.line_description }}</td>
            <td>{{ row.qty_remaining }}</td>
            <td>{{ row.ship_by or '' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No still-open lines.</p>
{% endif %}

<h3>Completed Lines</h3>
{% if completed_lines %}
<table class="data-table">
    <thead>
        <tr>
            <th>SO No</th>
            <th>Customer</th>
            <th>Item</th>
            <th>Description</th>
            <th>Qty Remaining (Last)</th>
        </tr>
    </thead>
    <tbody>
        {% for line in completed_lines %}
        <tr>
            <td>{{ line.so_no }}</td>
            <td>{{ line.customer_name }}</td>
            <td>{{ line.item_id }}</td>
            <td>{{ line.line_description }}</td>
            <td>{{ line.qty_remaining }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No completed lines.</p>
{% endif %}

<form method="post" action="{{ url_for('open_orders.commit_open_orders_import_route') }}">
    <input type="hidden" name="token" value="{{ token }}">
    <button type="submit" class="action-btn primary-action">Commit Import</button>
    <a href="{{ url_for('open_orders.open_orders_import') }}" class="action-btn subtle-action">Cancel</a>
</form>
{% endblock %}
