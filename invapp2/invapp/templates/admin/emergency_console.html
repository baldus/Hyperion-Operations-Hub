{% extends "base.html" %}

{% block content %}
<h2>Emergency Command Console</h2>
<p class="page-intro">Run curated recovery commands while the operations console is in emergency mode. Results are captured below so you can validate each step without leaving the browser.</p>

{% if not database_online %}
<div class="offline-card emergency-card" role="status">
    <h3>Emergency access active</h3>
    <p>The database connection is offline. Commands will run on the application host using the console service account.</p>
</div>
{% else %}
<div class="offline-card emergency-card emergency-card--online" role="status">
    <h3>Database connected</h3>
    <p>You can still use these helpers to restart services or install packages as needed.</p>
</div>
{% endif %}

{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<form method="post" class="emergency-actions-form">
    <div class="emergency-actions-grid">
        {% for action in actions %}
        <section class="emergency-action-card">
            <header class="emergency-action-header">
                <h3>{{ action.title }}</h3>
                <p>{{ action.description }}</p>
            </header>
            <button type="submit" name="action_id" value="{{ action.id }}" class="emergency-action-button"{% if selected_action_id == action.id %} aria-current="true"{% endif %}>{{ action.button_label }}</button>
            {% if action.note %}
            <p class="action-note">{{ action.note }}</p>
            {% endif %}
        </section>
        {% endfor %}
    </div>
</form>

<section class="custom-command-section">
    <h3>Run a custom command</h3>
    <p>Need something else? Enter a command that starts with one of the approved binaries below. Commands run with a 10 minute timeout.</p>
    <p>Try <code>bash support/run_diagnostics.sh</code> to collect a troubleshooting snapshot.</p>
    <p class="approved-commands">Allowed starters: {{ allowed_custom_binaries | join(', ') }}</p>
    <form method="post" class="custom-command-form">
        <label for="custom_command" class="sr-only">Custom command</label>
        <textarea id="custom_command" name="custom_command" rows="3" placeholder="sudo systemctl status postgresql" required>{{ custom_command }}</textarea>
        <div class="custom-command-actions">
            <button type="submit" class="action-btn">Run custom command</button>
        </div>
    </form>
</section>

{% if command_result %}
<section class="command-output" aria-live="polite">
    <h3>{{ command_result.label }}</h3>
    <p class="command-output-summary">
        {% if command_result.steps %}
        Overall exit code <code>{{ command_result.exit_code }}</code>.
        {% if command_result.note %}<span class="command-output-note">{{ command_result.note }}</span>{% endif %}
        {% else %}
        Ran as <code>{{ command_result.command }}</code> and exited with code <code>{{ command_result.exit_code }}</code>.
        {% if command_result.note %}<span class="command-output-note">{{ command_result.note }}</span>{% endif %}
        {% endif %}
    </p>
    {% if command_result.steps %}
    <ol class="command-output-steps">
        {% for step in command_result.steps %}
        <li class="command-step">
            <header class="command-step-header">
                <h4>{{ loop.index }}. {{ step.label }}</h4>
                <p class="command-step-meta">
                    Ran <code>{{ step.command }}</code> • Exit code <code>{{ step.exit_code }}</code>
                    {% if step.note %}<span class="command-step-note">{{ step.note }}</span>{% endif %}
                </p>
            </header>
            <div class="command-output-columns">
                <article>
                    <h5>Standard output</h5>
                    <pre><code>{{ step.stdout or '—' }}</code></pre>
                </article>
                <article>
                    <h5>Standard error</h5>
                    <pre><code>{{ step.stderr or '—' }}</code></pre>
                </article>
            </div>
        </li>
        {% endfor %}
    </ol>
    {% else %}
    <div class="command-output-columns">
        <article>
            <h4>Standard output</h4>
            <pre><code>{{ command_result.stdout or '—' }}</code></pre>
        </article>
        <article>
            <h4>Standard error</h4>
            <pre><code>{{ command_result.stderr or '—' }}</code></pre>
        </article>
    </div>
    {% endif %}
</section>
{% endif %}
{% endblock %}
