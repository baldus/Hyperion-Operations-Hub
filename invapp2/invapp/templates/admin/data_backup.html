{% extends "base.html" %}

{% block content %}
<h2>Data Backup</h2>
<p class="lead">Download a full backup of the system data or restore from a previous backup.</p>

<section aria-labelledby="export-title" class="card-section">
    <h3 id="export-title">Export Data</h3>
    <p>Download a zipped SQL backup of every table in the system.</p>
    {% if last_backup %}
        <p class="page-meta">
            Last successful backup: {{ last_backup.finished_at.strftime('%Y-%m-%d %H:%M UTC') }}
            ({{ last_backup.filename }})
        </p>
    {% else %}
        <p class="page-meta">No successful backups recorded yet.</p>
    {% endif %}
    <form method="post" action="{{ url_for('admin.export_data') }}">
        <button type="submit" class="action-btn">Download Backup</button>
    </form>
</section>

<section aria-labelledby="import-title" class="card-section">
    <h3 id="import-title">Import Data</h3>
    <p>Upload a JSON backup file to restore the system state.</p>
    <form id="backup-import-form" method="post" action="{{ url_for('admin.import_data') }}" enctype="multipart/form-data">
        <label for="backup-file" class="sr-only">Backup file</label>
        <input
            id="backup-file"
            type="file"
            name="backup_file"
            accept="application/json,application/gzip,.json,.gz"
            required
        >
        <button type="submit" class="action-btn" data-default-label="Upload Backup">Upload Backup</button>
    </form>
    <div
        id="backup-upload-status"
        class="upload-status"
        role="status"
        aria-live="polite"
        hidden
        data-uploading-message="Uploading backup&hellip; Large files may take several minutes to process."
    >
        <div class="upload-status__spinner" aria-hidden="true"></div>
        <p class="upload-status__message" data-default-message=""></p>
    </div>
</section>

<section aria-labelledby="tables-title" class="card-section">
    <h3 id="tables-title">Tables Included</h3>
    <ul class="table-list">
        {% for table_name in table_names %}
            <li>{{ table_name }}</li>
        {% endfor %}
    </ul>
</section>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("backup-import-form");
        if (!form) {
            return;
        }

        const status = document.getElementById("backup-upload-status");
        const submitButton = form.querySelector("button[type='submit']");
        const fileInput = form.querySelector("#backup-file");

        const message = status ? status.querySelector(".upload-status__message") : null;
        const defaultStatusMessage = message
            ? (message.dataset.defaultMessage !== undefined
                ? message.dataset.defaultMessage
                : message.textContent || "")
            : "";
        const uploadingMessage = status ? status.dataset.uploadingMessage : "";

        const resetStatus = () => {
            if (status) {
                status.hidden = true;
                status.classList.remove("upload-status--active");
            }

            if (message) {
                message.textContent = defaultStatusMessage;
            }
        };

        resetStatus();

        form.addEventListener("submit", () => {
            if (form.checkValidity() && status) {
                if (message) {
                    message.textContent = uploadingMessage || "Uploading backup…";
                }
                status.hidden = false;
                status.classList.add("upload-status--active");
            }

            if (submitButton) {
                const defaultLabel = submitButton.dataset.defaultLabel || submitButton.textContent;
                submitButton.dataset.defaultLabel = defaultLabel;
                submitButton.textContent = "Uploading…";
                submitButton.disabled = true;
            }
        });

        if (fileInput) {
            fileInput.addEventListener("change", () => {
                if (submitButton && submitButton.disabled) {
                    submitButton.disabled = false;
                    submitButton.textContent = submitButton.dataset.defaultLabel || "Upload Backup";
                }

                resetStatus();
            });
        }

        form.addEventListener("reset", resetStatus);
    });
</script>
{% endblock %}
