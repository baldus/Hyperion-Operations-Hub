{% extends "base.html" %}

{% block content %}
<h2>Auto Backups</h2>
<p class="lead">Download or clean up automated backup archives.</p>

<section class="card-section">
    <h3>Backup Status</h3>
    {% if backup_status %}
        <p class="page-meta">
            Last run: {{ backup_status.started_at.strftime('%Y-%m-%d %H:%M UTC') }}
            {% if backup_status.finished_at %}
                &middot; Completed {{ backup_status.finished_at.strftime('%Y-%m-%d %H:%M UTC') }}
            {% else %}
                &middot; In progress
            {% endif %}
        </p>
        <p>Status: {{ backup_status.status | title }}{% if backup_status.message %} â€” {{ backup_status.message }}{% endif %}</p>
    {% else %}
        <p class="page-meta">No automated backup runs recorded yet.</p>
    {% endif %}
    {% if backup_dirs %}
        <p class="page-meta">Auto backup directories:</p>
        <ul class="link-list">
            {% for backup_dir in backup_dirs %}
                <li>{{ backup_dir }}</li>
            {% endfor %}
        </ul>
    {% endif %}
</section>

<section class="card-section">
    <div class="section-header">
        <h3>Available Auto Backups</h3>
    </div>
    <label for="backup-filter" class="sr-only">Search backups</label>
    <input id="backup-filter" type="search" placeholder="Search backups by filename">
    {% if backups %}
    <div class="table-responsive" id="auto-backups-table">
        <table class="table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Created</th>
                    <th>Age</th>
                    <th>Size</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for backup in backups %}
                <tr data-filename="{{ backup.filename | lower }}">
                    <td>
                        {{ backup.filename }}
                        {% if backup.is_latest %}
                            <span class="badge">Latest</span>
                        {% endif %}
                    </td>
                    <td>{{ backup.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</td>
                    <td>{{ backup.age_display }}</td>
                    <td>{{ backup.size_hr }}</td>
                    <td class="row-actions">
                        <a class="link-btn" href="{{ url_for('admin.download_auto_backup', filename=backup.filename) }}">Download</a>
                        <form method="post" action="{{ url_for('admin.delete_auto_backup', filename=backup.filename) }}" class="inline-form" onsubmit="return confirm('Delete this backup? This cannot be undone.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="link-btn danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>No automated backups found.</p>
    {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const filterInput = document.getElementById("backup-filter");
    const table = document.getElementById("auto-backups-table");
    if (filterInput && table) {
        filterInput.addEventListener("input", (event) => {
            const query = event.target.value.toLowerCase();
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach((row) => {
                const filename = row.dataset.filename || "";
                row.style.display = filename.includes(query) ? "" : "none";
            });
        });
    }
</script>
{% endblock %}
