{% extends "base.html" %}

{% block content %}
<h2>Backup Restore</h2>
<p class="lead">Review available backups and restore the database when needed.</p>

{% if message %}
<div class="alert alert-warning">{{ message }}</div>
{% endif %}

{% if backup_dir %}
<p class="page-meta">Backup directory: {{ backup_dir }}</p>
{% endif %}

<section class="card-section">
    <h3>Available Backups</h3>
    {% if backups %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Created</th>
                    <th>Size</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {% for backup in backups %}
                <tr>
                    <td>{{ backup.filename }}</td>
                    <td>{{ backup.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</td>
                    <td>{{ (backup.size / 1024) | round(1) }} KB</td>
                    <td>{{ 'Database' if backup.kind == 'db' else 'Files' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No backups found.</p>
    {% endif %}
</section>

<section class="card-section">
    <h3>Restore Database</h3>
    <div class="alert alert-warning">
        WARNING: Restoring will overwrite the current database. Use only when necessary.
    </div>
    {% if is_superuser() %}
        <form method="post" action="{{ url_for('admin.restore_backup') }}" class="stacked-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <label for="backup-filename">Select a database backup (.sql or .dump)</label>
            <select id="backup-filename" name="backup_filename" required>
                <option value="">Select a backup</option>
                {% for backup in backups if backup.kind == 'db' %}
                    <option value="{{ backup.filename }}">{{ backup.filename }}</option>
                {% endfor %}
            </select>

            <label class="checkbox">
                <input type="checkbox" name="confirm_ack" value="yes" required>
                I understand this will overwrite the current database.
            </label>

            <label for="confirm-restore">Type RESTORE to confirm</label>
            <input id="confirm-restore" type="text" name="confirm_restore" placeholder="RESTORE" required>

            <button type="submit" class="action-btn">Restore Backup</button>
        </form>
    {% else %}
        <p class="text-muted">Restore actions are available to superusers only.</p>
    {% endif %}
</section>
{% endblock %}
