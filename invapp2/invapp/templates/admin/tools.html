{% extends "base.html" %}

{% block content %}
<h2>Administrator Tools</h2>
<p class="page-intro">Monitor the health of the operations console and launch deeper administration utilities.</p>

<section class="card-section">
    <h3>System Health</h3>
    <div class="status-grid">
        {% for card in system_health %}
        <article class="status-card status-{{ card.level }}">
            <p class="status-title">{{ card.title }}</p>
            <p class="status-metric">{{ card.metric }}</p>
            {% set progress = card.get('progress') %}
            {% if progress %}
            <div class="progress-label">
                <span>{{ progress.left }}</span>
                <span>{{ progress.right }}</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" style="width: {{ '%.1f'|format(progress.percent) }}%"></div>
            </div>
            {% endif %}
            {% if card.get('meta') %}
            <p class="status-meta">{{ card.meta }}</p>
            {% endif %}
        </article>
        {% endfor %}
    </div>
</section>

<section class="card-section">
    <h3>Operations Shortcuts</h3>
    <p>Jump directly to the tools administrators use most often.</p>
    {% if not database_online %}
    <div class="offline-card">
        <p>Database-dependent shortcuts are temporarily paused while the console runs in emergency mode. Restore connectivity to unlock the full toolkit.</p>
    </div>
    {% endif %}
    <div class="link-list">
        {% for link in quick_links %}
        <a href="{{ link.href if link.href else '#' }}" class="link-item{% if link.disabled %} is-disabled{% endif %}" {% if link.disabled %}aria-disabled="true"{% endif %}>
            <span class="link-label">{{ link.label }}</span>
            {% if link.note %}
            <span class="link-note">{{ link.note }}</span>
            {% endif %}
        </a>
        {% endfor %}
    </div>
    <div class="error-report-log">
        <div class="log-header">
            <h4>Recent Error Reports</h4>
            <p>Submitted from the error screen when something goes wrong.</p>
        </div>
        {% if not database_online %}
        <p class="empty-text">Error reports are unavailable while the database is offline.</p>
        {% elif error_reports %}
        <ul class="log-list" aria-label="Recent error reports">
            {% for report in error_reports %}
            <li class="log-item">
                <p class="log-primary">{{ report.summary() }}</p>
                <p class="log-meta">
                    Reported {{ report.occurred_at.strftime('%b %d, %Y %H:%M UTC') }}
                    {% if report.username %} by {{ report.username }}{% endif %}
                    {% if report.path %} on {{ report.path }}{% endif %}
                </p>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-text">No error reports have been submitted yet.</p>
        {% endif %}
    </div>
</section>

<section class="card-section">
    <h3>Clear All Inventory (Start Fresh)</h3>
    <p class="section-intro">
        Remove every stock movement, batch, and inventory history record so you can restart
        inventory counts from zero. This keeps items, locations, orders, and users intact.
    </p>
    <p class="field-note">
        {% if last_backup %}
        Most recent backup: {{ last_backup.started_at.strftime('%b %d, %Y %H:%M UTC') }}
        ({{ last_backup.status }}{% if last_backup.filename %} â€¢ {{ last_backup.filename }}{% endif %})
        {% else %}
        Most recent backup: No backups have been recorded yet.
        {% endif %}
    </p>
    <button type="button" class="action-btn action-btn--danger" id="openClearInventoryModal">
        Clear All Inventory (Start Fresh)
    </button>
</section>

<div id="clearInventoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="clearInventoryTitle">
    <div class="modal-content">
        <h3 id="clearInventoryTitle">Confirm Inventory Wipe</h3>
        <p class="section-intro">
            This will permanently delete all inventory quantities, batches, movements, and history records.
            It cannot be undone.
        </p>
        <form method="post" action="{{ url_for('admin.clear_inventory') }}" class="stacked-form">
            <input type="hidden" name="csrf_token" value="{{ clear_inventory_csrf_token }}">
            <label class="checkbox-row">
                <input type="checkbox" name="confirm_clear" value="1" id="confirmClearCheckbox">
                I understand this will permanently delete inventory quantities and related records and cannot be undone.
            </label>
            <label for="confirmPhrase">Type "{{ clear_inventory_phrase }}" to confirm</label>
            <input type="text" id="confirmPhrase" name="confirm_phrase" autocomplete="off" placeholder="{{ clear_inventory_phrase }}">
            <label for="confirmPassword">Confirm your password</label>
            <input type="password" id="confirmPassword" name="confirm_password" autocomplete="current-password">
            <div class="modal-actions">
                <button type="button" class="action-btn secondary" id="cancelClearInventory">Cancel</button>
                <button type="submit" class="action-btn action-btn--danger" id="confirmClearInventory" disabled>
                    Yes, Clear Inventory
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const modal = document.getElementById('clearInventoryModal');
const openButton = document.getElementById('openClearInventoryModal');
const cancelButton = document.getElementById('cancelClearInventory');
const confirmButton = document.getElementById('confirmClearInventory');
const checkbox = document.getElementById('confirmClearCheckbox');
const phraseInput = document.getElementById('confirmPhrase');
const passwordInput = document.getElementById('confirmPassword');
const requiredPhrase = "{{ clear_inventory_phrase }}";

function updateConfirmButton() {
    const phraseMatches = phraseInput.value.trim().toUpperCase() === requiredPhrase;
    const passwordReady = passwordInput.value.trim().length > 0;
    confirmButton.disabled = !(checkbox.checked && phraseMatches && passwordReady);
}

openButton.addEventListener('click', () => {
    modal.style.display = 'block';
    updateConfirmButton();
});

cancelButton.addEventListener('click', () => {
    modal.style.display = 'none';
});

window.addEventListener('click', (event) => {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});

checkbox.addEventListener('change', updateConfirmButton);
phraseInput.addEventListener('input', updateConfirmButton);
passwordInput.addEventListener('input', updateConfirmButton);
</script>
{% endblock %}
