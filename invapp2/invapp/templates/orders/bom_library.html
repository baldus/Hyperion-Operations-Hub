{% extends "base.html" %}
{% block content %}
<h2>BOM Template Library</h2>

<section class="form-section">
    <h3>Existing Templates</h3>
    {% if templates %}
        <div class="table-scroll">
            <table class="form-table">
                <thead>
                    <tr>
                        <th>Finished Good</th>
                        <th>Components</th>
                        <th>Last Updated</th>
                        <th class="actions-col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for template in templates %}
                        <tr>
                            <td>
                                <div class="finished-good">
                                    <span class="sku">{{ template.item.sku }}</span>
                                    <span class="name">{{ template.item.name }}</span>
                                </div>
                            </td>
                            <td>
                                {% if template.components %}
                                    <ul class="inline-list">
                                        {% for component in template.components %}
                                            <li>{{ component.component_item.sku }} × {{ component.quantity }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="muted">No components listed</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ template.updated_at.strftime('%Y-%m-%d %H:%M') if template.updated_at else '—' }}
                            </td>
                            <td class="row-actions">
                                <a href="{{ url_for('orders.bom_library', sku=template.item.sku) }}" class="link-btn">Edit</a>
                                <form method="post" class="inline-form" onsubmit="return confirm('Delete the BOM template for {{ template.item.sku }}?');">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="finished_good_sku" value="{{ template.item.sku }}">
                                    <button type="submit" class="link-btn danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="section-help">No BOM templates are stored yet. Create one using the forms below.</p>
    {% endif %}
</section>

<section class="form-section">
    <h3>Create or Update a Template</h3>
    {% if editing_template %}
        <p class="section-help">
            Editing stored template for <strong>{{ editing_template.item.sku }}</strong>.
            <a href="{{ url_for('orders.bom_library') }}">Start a new template</a>
            to create a different BOM.
        </p>
    {% endif %}
    <form method="post" id="bom-template-form" class="form-stack">
        <input type="hidden" name="action" value="create">
        <div class="form-grid">
            <label class="form-field">
                <span class="field-label">Finished Good Part Number</span>
                <input type="text" name="finished_good_sku" list="bom-item-skus" value="{{ form_data.finished_good_sku }}" required>
            </label>
        </div>
        <datalist id="bom-item-skus">
            {% for item in items %}
                <option value="{{ item.sku }}">{{ item.name }}</option>
            {% endfor %}
        </datalist>
        <div class="section-header">
            <h4>Template Components</h4>
            <button type="button" class="action-btn" id="library-add-component">Add Component</button>
        </div>
        <div class="table-scroll">
            <table class="form-table">
                <thead>
                    <tr>
                        <th>Component SKU</th>
                        <th>Quantity Per</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="library-bom-rows"></tbody>
            </table>
        </div>
        <input type="hidden" name="bom_data" id="library-bom-data">
        <div class="form-actions">
            <button type="submit" class="action-btn">{{ 'Save Changes' if editing_template else 'Save Template' }}</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Import from CSV</h3>
    <form method="post" enctype="multipart/form-data" class="form-stack">
        <input type="hidden" name="action" value="import_csv">
        <div class="form-grid">
            <label class="form-field">
                <span class="field-label">Finished Good Part Number</span>
                <input type="text" name="finished_good_sku" list="bom-item-skus" value="{{ form_data.finished_good_sku }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">CSV File</span>
                <input type="file" name="csv_file" accept=".csv" required>
            </label>
        </div>
        <p class="section-help">The CSV must include headers <code>component_sku</code> and <code>quantity</code>.</p>
        <div class="form-actions">
            <button type="submit" class="action-btn">Import Template</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Bulk Import BOMs</h3>
    <form method="post" enctype="multipart/form-data" class="form-stack" id="bulk-bom-import-form">
        <input type="hidden" name="action" value="bulk_import">
        <div class="form-grid">
            <label class="form-field">
                <span class="field-label">CSV File</span>
                <input type="file" name="csv_file" id="bulk-import-file" accept=".csv" required>
            </label>
            <label class="form-field">
                <span class="field-label">Finished Good Column</span>
                <input type="text" name="assembly_field" id="bulk-assembly-field" value="{{ bulk_import_form.assembly_field }}" list="bulk-import-column-options" required>
            </label>
            <label class="form-field">
                <span class="field-label">Component Column</span>
                <input type="text" name="component_field" id="bulk-component-field" value="{{ bulk_import_form.component_field }}" list="bulk-import-column-options" required>
            </label>
            <label class="form-field">
                <span class="field-label">Quantity Column</span>
                <input type="text" name="quantity_field" id="bulk-quantity-field" value="{{ bulk_import_form.quantity_field }}" list="bulk-import-column-options" required>
            </label>
        </div>
        <p class="section-help">
            Upload a CSV that lists finished goods and their components. Each row should include the finished good, component,
            and quantity. Use the fields above to map the CSV columns to the appropriate values.
        </p>
        <div class="form-actions">
            <button type="submit" class="action-btn">Import BOMs</button>
        </div>
    </form>
</section>

<datalist id="library-component-skus">
    {% for item in items %}
        <option value="{{ item.sku }}">{{ item.name }}</option>
    {% endfor %}
</datalist>

<datalist id="bulk-import-column-options"></datalist>

<script>
(function() {
    const initialData = {{ form_data|tojson }};
    const bomBody = document.getElementById('library-bom-rows');
    const addComponentBtn = document.getElementById('library-add-component');
    const dataInput = document.getElementById('library-bom-data');
    const form = document.getElementById('bom-template-form');

    function createRow(values = {}) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="text" class="component-sku" placeholder="Component SKU" list="library-component-skus">
            </td>
            <td>
                <input type="number" class="component-qty" min="1" placeholder="Qty">
            </td>
            <td class="row-actions">
                <button type="button" class="link-btn remove-row">Remove</button>
            </td>
        `;
        const skuInput = row.querySelector('.component-sku');
        const qtyInput = row.querySelector('.component-qty');
        if (values.sku !== undefined) {
            skuInput.value = values.sku;
        }
        if (values.quantity !== undefined) {
            qtyInput.value = values.quantity;
        }
        row.querySelector('.remove-row').addEventListener('click', () => {
            row.remove();
        });
        bomBody.appendChild(row);
    }

    function collectPayload() {
        const entries = [];
        bomBody.querySelectorAll('tr').forEach(row => {
            const sku = row.querySelector('.component-sku').value.trim();
            const quantity = row.querySelector('.component-qty').value.trim();
            if (!sku && !quantity) {
                return;
            }
            entries.push({ sku, quantity });
        });
        return entries;
    }

    if (addComponentBtn) {
        addComponentBtn.addEventListener('click', () => createRow());
    }

    const initialComponents = Array.isArray(initialData.bom) && initialData.bom.length ? initialData.bom : [{}];
    initialComponents.forEach(component => createRow(component));

    if (form) {
        form.addEventListener('submit', () => {
            const payload = collectPayload();
            dataInput.value = JSON.stringify(payload);
        });
    }
})();

(function() {
    const fileInput = document.getElementById('bulk-import-file');
    const columnOptions = document.getElementById('bulk-import-column-options');
    const assemblyInput = document.getElementById('bulk-assembly-field');
    const componentInput = document.getElementById('bulk-component-field');
    const quantityInput = document.getElementById('bulk-quantity-field');

    if (!fileInput || !columnOptions) {
        return;
    }

    const inputs = [assemblyInput, componentInput, quantityInput];
    inputs.forEach(input => {
        if (!input) {
            return;
        }
        input.addEventListener('input', () => {
            input.dataset.userEdited = 'true';
        });
    });

    const defaultSuggestions = {
        assembly: ['Assembly', 'Finished Good', 'FinishedGood', 'Parent'],
        component: ['Component', 'Component SKU', 'ComponentSku', 'Child'],
        quantity: ['Qty', 'Quantity', 'Qty Per']
    };

    function splitHeader(line) {
        const headers = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i += 1) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i += 1;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                headers.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        headers.push(current.trim());
        return headers.filter(value => value.length);
    }

    function setDefaultValue(input, candidates, headers) {
        if (!input || input.dataset.userEdited === 'true') {
            return;
        }
        const lowerHeaders = headers.map(value => value.toLowerCase());
        for (const candidate of candidates) {
            const index = lowerHeaders.indexOf(candidate.toLowerCase());
            if (index !== -1) {
                input.value = headers[index];
                break;
            }
        }
    }

    function updateColumnOptions(headers) {
        columnOptions.innerHTML = '';
        headers.forEach(header => {
            const option = document.createElement('option');
            option.value = header;
            columnOptions.appendChild(option);
        });
        setDefaultValue(assemblyInput, defaultSuggestions.assembly, headers);
        setDefaultValue(componentInput, defaultSuggestions.component, headers);
        setDefaultValue(quantityInput, defaultSuggestions.quantity, headers);
    }

    fileInput.addEventListener('change', () => {
        const [file] = fileInput.files;
        if (!file) {
            columnOptions.innerHTML = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = event => {
            const text = (event.target && event.target.result) ? String(event.target.result) : '';
            const lines = text.split(/\r?\n/);
            const headerLine = lines.find(line => line.trim().length);
            if (!headerLine) {
                columnOptions.innerHTML = '';
                return;
            }
            const headers = splitHeader(headerLine);
            updateColumnOptions(headers);
        };
        reader.readAsText(file.slice(0, 65536));
    });
})();
</script>
{% endblock %}
