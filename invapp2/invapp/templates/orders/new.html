{% extends "base.html" %}
{% block content %}
<h2>Create Order</h2>
<form method="post" id="new-order-form" class="form-stack">
    <section class="form-section">
        <h3>Order Details</h3>
        <div class="form-grid">
            <label class="form-field">
                <span class="field-label">Order Number</span>
                <input type="text" name="order_number" value="{{ form_data.order_number }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Customer Name</span>
                <input type="text" name="customer_name" value="{{ form_data.customer_name }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Finished Good Part Number</span>
                <input type="text" name="finished_good_sku" list="item-skus" value="{{ form_data.finished_good_sku }}" required>
                <datalist id="item-skus">
                    {% for item in items %}
                    <option value="{{ item.sku }}">{{ item.name }}</option>
                    {% endfor %}
                </datalist>
            </label>
            <label class="form-field">
                <span class="field-label">Order Created By</span>
                <input type="text" name="created_by" value="{{ form_data.created_by }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Quantity</span>
                <input type="number" name="quantity" min="1" value="{{ form_data.quantity }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Promised Ship Date</span>
                <input type="date" name="promised_date" value="{{ form_data.promised_date }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Scheduled Start Date</span>
                <input type="date" name="scheduled_start_date" value="{{ form_data.scheduled_start_date }}" required>
            </label>
            <label class="form-field">
                <span class="field-label">Scheduled Completion Date</span>
                <input type="date" name="scheduled_completion_date" value="{{ form_data.scheduled_completion_date }}" required>
            </label>
        </div>
        <label class="form-field">
            <span class="field-label">General Notes</span>
            <textarea name="general_notes" rows="4">{{ form_data.general_notes }}</textarea>
        </label>
    </section>

    <section class="form-section">
        <div class="section-header">
            <h3>Bill of Materials</h3>
            <button type="button" class="action-btn" id="add-bom-component">Add Component</button>
        </div>
        <p class="section-help">List each component required to manufacture the finished good. Use valid component SKUs from inventory.</p>
        <div class="table-scroll">
            <table class="form-table">
                <thead>
                    <tr>
                        <th>Component SKU</th>
                        <th>Quantity Per</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bom-rows"></tbody>
            </table>
        </div>
    </section>

    <section class="form-section">
        <div class="section-header">
            <h3>Routing Steps</h3>
            <div class="section-actions">
                <button type="button" class="action-btn secondary" id="import-routing-steps">Import Steps</button>
                <button type="button" class="action-btn" id="add-routing-step">Add Step</button>
            </div>
        </div>
        <p class="section-help">Define the work sequence, indicating the work cell, instructions, and which components are consumed during the step.</p>
        <div id="routing-import-panel" class="import-panel" hidden>
            <p class="import-instructions">Paste or type routing steps using tabs or commas to separate the sequence, work cell, instructions, and component columns. Component SKUs can be listed together separated by commas, semicolons, spaces, or placed in their own columns.</p>
            <pre class="import-example">Sequence    Work Cell    Instructions    Components
10    Assembly    Assemble parts    CMP-100; CMP-200</pre>
            <textarea id="routing-import-input" rows="6" placeholder="Example: 10    Assembly    Assemble parts    CMP-100; CMP-200"></textarea>
            <div class="import-actions">
                <button type="button" class="action-btn" id="routing-import-apply">Use Imported Steps</button>
                <button type="button" class="action-btn secondary" id="routing-import-cancel">Cancel</button>
            </div>
            <p class="import-error" id="routing-import-error"></p>
        </div>
        <div class="table-scroll">
            <table class="form-table">
                <thead>
                    <tr>
                        <th>Sequence</th>
                        <th>Work Cell</th>
                        <th>Instructions</th>
                        <th>Components Used</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="routing-rows"></tbody>
            </table>
        </div>
    </section>

    <input type="hidden" name="bom_data" id="bom-data">
    <input type="hidden" name="routing_data" id="routing-data">

    <div class="form-actions">
        <button type="submit" class="action-btn">Create Order</button>
        <a href="{{ url_for('orders.orders_home') }}" class="action-btn secondary">Cancel</a>
    </div>
</form>

<script>
(function() {
    const initialData = {{ form_data|tojson }};
    const bomBody = document.getElementById('bom-rows');
    const routingBody = document.getElementById('routing-rows');
    const bomDataInput = document.getElementById('bom-data');
    const routingDataInput = document.getElementById('routing-data');
    const addBomButton = document.getElementById('add-bom-component');
    const addRoutingButton = document.getElementById('add-routing-step');
    const importRoutingButton = document.getElementById('import-routing-steps');
    const routingImportPanel = document.getElementById('routing-import-panel');
    const routingImportInput = document.getElementById('routing-import-input');
    const routingImportApply = document.getElementById('routing-import-apply');
    const routingImportCancel = document.getElementById('routing-import-cancel');
    const routingImportError = document.getElementById('routing-import-error');
    const form = document.getElementById('new-order-form');

    function createBomRow(values = {}) {
        const row = document.createElement('tr');
        row.classList.add('bom-row');
        row.innerHTML = `
            <td>
                <input type="text" class="bom-sku" placeholder="Component SKU" list="item-skus">
            </td>
            <td>
                <input type="number" class="bom-quantity" min="1" placeholder="Qty">
            </td>
            <td class="row-actions">
                <button type="button" class="link-btn remove-bom">Remove</button>
            </td>
        `;
        const skuInput = row.querySelector('.bom-sku');
        const quantityInput = row.querySelector('.bom-quantity');
        if (values.sku !== undefined) {
            skuInput.value = values.sku;
        }
        if (values.quantity !== undefined) {
            quantityInput.value = values.quantity;
        }
        skuInput.addEventListener('input', updateStepComponentOptions);
        quantityInput.addEventListener('input', updateStepComponentOptions);
        row.querySelector('.remove-bom').addEventListener('click', () => {
            row.remove();
            updateStepComponentOptions();
        });
        bomBody.appendChild(row);
        updateStepComponentOptions();
    }

    function createRoutingRow(values = {}) {
        const row = document.createElement('tr');
        row.classList.add('routing-row');
        row.dataset.selectedComponents = JSON.stringify(values.components || []);
        row.innerHTML = `
            <td>
                <input type="number" class="step-sequence" min="1" placeholder="#">
            </td>
            <td>
                <input type="text" class="step-work-cell" placeholder="Work Cell">
            </td>
            <td>
                <textarea class="step-instructions" rows="2" placeholder="Detailed instructions" required></textarea>
            </td>
            <td>
                <select multiple class="step-components-select"></select>
            </td>
            <td class="row-actions">
                <button type="button" class="link-btn remove-step">Remove</button>
            </td>
        `;
        const sequenceInput = row.querySelector('.step-sequence');
        const workCellInput = row.querySelector('.step-work-cell');
        const instructionsInput = row.querySelector('.step-instructions');
        if (values.sequence !== undefined) {
            sequenceInput.value = values.sequence;
        }
        if (values.work_cell !== undefined) {
            workCellInput.value = values.work_cell;
        }
        if (values.instructions !== undefined) {
            instructionsInput.value = values.instructions;
        }
        row.querySelector('.remove-step').addEventListener('click', () => {
            row.remove();
        });
        const select = row.querySelector('.step-components-select');
        select.addEventListener('change', () => {
            row.dataset.selectedComponents = JSON.stringify(Array.from(select.selectedOptions).map(opt => opt.value));
        });
        routingBody.appendChild(row);
        updateStepComponentOptions();
    }

    function getBomOptions() {
        return Array.from(bomBody.querySelectorAll('tr')).map(row => {
            const sku = row.querySelector('.bom-sku').value.trim();
            const quantity = row.querySelector('.bom-quantity').value.trim();
            return { sku, quantity };
        }).filter(component => component.sku !== '');
    }

    function updateStepComponentOptions() {
        const components = getBomOptions();
        routingBody.querySelectorAll('.routing-row').forEach(row => {
            const select = row.querySelector('.step-components-select');
            const existingSelection = new Set(Array.from(select.selectedOptions).map(opt => opt.value));
            let configuredSelection = [];
            try {
                configuredSelection = JSON.parse(row.dataset.selectedComponents || '[]');
            } catch (err) {
                configuredSelection = [];
            }
            select.innerHTML = '';
            components.forEach(component => {
                const option = document.createElement('option');
                option.value = component.sku;
                const qtyLabel = component.quantity ? ` (qty ${component.quantity})` : '';
                option.textContent = `${component.sku}${qtyLabel}`;
                if (existingSelection.size > 0) {
                    option.selected = existingSelection.has(component.sku);
                } else if (configuredSelection.includes(component.sku)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            row.dataset.selectedComponents = JSON.stringify(Array.from(select.selectedOptions).map(opt => opt.value));
        });
    }

    function normalizeDelimitedCell(cell) {
        let value = (cell || '').replace(/\r/g, '').trim();
        if (value.startsWith('"') && value.endsWith('"') && value.length >= 2) {
            value = value.slice(1, -1).replace(/""/g, '"');
        }
        return value;
    }

    function splitCsvLine(line) {
        const cells = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i += 1) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i += 1;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                cells.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        cells.push(current);
        return cells;
    }

    function parseComponentValues(tokens) {
        const cleaned = tokens
            .map(token => normalizeDelimitedCell(token))
            .filter(value => value !== '');
        if (!cleaned.length) {
            return [];
        }
        const combined = cleaned.join(' ');
        return combined
            .split(/[\s,;|]+/)
            .map(part => part.trim())
            .filter(part => part !== '');
    }

    function parseRoutingLine(line) {
        const trimmedLine = (line || '').trim();
        if (!trimmedLine) {
            return { skip: true };
        }
        const rawCells = trimmedLine.includes('\t') ? trimmedLine.split('\t') : splitCsvLine(trimmedLine);
        const cells = rawCells.map(cell => normalizeDelimitedCell(cell));
        while (cells.length && cells[cells.length - 1] === '') {
            cells.pop();
        }
        if (!cells.length) {
            return { skip: true };
        }
        const sequenceRaw = cells[0] || '';
        if (!sequenceRaw) {
            return { error: 'Missing sequence number.' };
        }
        const sequenceNumber = Number(sequenceRaw);
        if (!Number.isFinite(sequenceNumber) || !Number.isInteger(sequenceNumber)) {
            return { error: 'Sequence must be a whole number.' };
        }
        let workCell = '';
        let instructions = '';
        if (cells.length >= 3) {
            workCell = cells[1] || '';
            instructions = cells[2] || '';
        } else if (cells.length === 2) {
            instructions = cells[1] || '';
        }
        if (!instructions) {
            return { error: 'Instructions are required.' };
        }
        const componentTokens = cells.slice(3);
        const components = [];
        parseComponentValues(componentTokens).forEach(sku => {
            if (!components.includes(sku)) {
                components.push(sku);
            }
        });
        return {
            step: {
                sequence: sequenceNumber,
                work_cell: workCell,
                instructions: instructions,
                components: components,
            },
        };
    }

    function parseRoutingImport(text) {
        const steps = [];
        const errors = [];
        const lines = (text || '').split(/\r?\n/);
        lines.forEach((line, index) => {
            const result = parseRoutingLine(line);
            if (!result || result.skip) {
                return;
            }
            if (result.error) {
                errors.push(`Line ${index + 1}: ${result.error}`);
            } else if (result.step) {
                steps.push(result.step);
            }
        });
        if (!steps.length && !errors.length) {
            errors.push('No routing steps were detected in the import.');
        }
        return { steps, errors };
    }

    function showRoutingImportPanel() {
        routingImportPanel.hidden = false;
        routingImportError.textContent = '';
        routingImportInput.focus();
        routingImportPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function hideRoutingImportPanel() {
        routingImportPanel.hidden = true;
        routingImportError.textContent = '';
    }

    function collectBomPayload() {
        const entries = [];
        bomBody.querySelectorAll('tr').forEach(row => {
            const sku = row.querySelector('.bom-sku').value.trim();
            const quantityValue = row.querySelector('.bom-quantity').value.trim();
            if (!sku && !quantityValue) {
                return;
            }
            entries.push({ sku: sku, quantity: quantityValue });
        });
        return entries;
    }

    function collectRoutingPayload() {
        const entries = [];
        routingBody.querySelectorAll('.routing-row').forEach(row => {
            const sequenceValue = row.querySelector('.step-sequence').value.trim();
            const workCell = row.querySelector('.step-work-cell').value.trim();
            const instructions = row.querySelector('.step-instructions').value.trim();
            const components = Array.from(row.querySelector('.step-components-select').selectedOptions).map(opt => opt.value);
            if (!sequenceValue && !instructions && components.length === 0) {
                return;
            }
            entries.push({
                sequence: sequenceValue,
                work_cell: workCell,
                instructions: instructions,
                components: components,
            });
        });
        return entries;
    }

    addBomButton.addEventListener('click', () => createBomRow());
    addRoutingButton.addEventListener('click', () => createRoutingRow());
    importRoutingButton.addEventListener('click', () => {
        showRoutingImportPanel();
    });
    routingImportCancel.addEventListener('click', () => {
        hideRoutingImportPanel();
    });
    routingImportApply.addEventListener('click', () => {
        const { steps, errors } = parseRoutingImport(routingImportInput.value);
        if (errors.length) {
            routingImportError.textContent = errors.join(' ');
            return;
        }
        routingBody.innerHTML = '';
        steps.forEach(step => createRoutingRow(step));
        hideRoutingImportPanel();
    });
    routingImportInput.addEventListener('input', () => {
        routingImportError.textContent = '';
    });

    const initialBom = Array.isArray(initialData.bom) && initialData.bom.length ? initialData.bom : [{}];
    initialBom.forEach(component => createBomRow(component));

    const initialSteps = Array.isArray(initialData.steps) && initialData.steps.length ? initialData.steps : [{}];
    initialSteps.forEach(step => createRoutingRow(step));

    form.addEventListener('submit', () => {
        const bomPayload = collectBomPayload();
        const routingPayload = collectRoutingPayload();
        bomDataInput.value = JSON.stringify(bomPayload);
        routingDataInput.value = JSON.stringify(routingPayload);
    });
})();
</script>
{% endblock %}
