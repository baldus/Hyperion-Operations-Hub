{% extends "base.html" %}

{% block content %}
<h2>Production Orders</h2>

<div class="orders-toolbar">
    <div class="toolbar-actions">
        {% if session.get('is_admin') %}
            <a href="{{ url_for('orders.new_order') }}" class="action-btn primary-action">Create New Order</a>
            <a href="{{ url_for('orders.bom_library') }}" class="action-btn subtle-action">BOM Library</a>
            <a href="{{ url_for('orders.view_waiting_orders') }}" class="action-btn subtle-action">Waiting on Material</a>
        {% endif %}
        <a href="{{ url_for('orders.view_open_orders') }}" class="action-btn subtle-action">Open Orders</a>
        <a href="{{ url_for('orders.view_closed_orders') }}" class="action-btn subtle-action">Closed Orders</a>
    </div>
    <form method="get" class="orders-filter">
        <label for="orders-search" class="sr-only">Search orders</label>
        <input id="orders-search" type="search" name="q" placeholder="Search by order # or finished good" value="{{ search_term }}">
        <button type="submit">Filter</button>
    </form>
</div>

{% if orders %}
<div class="table-scroll">
    <table class="orders-table">
        <thead>
            <tr>
                <th scope="col">Order #</th>
                <th scope="col">Finished Good</th>
                <th scope="col" class="numeric">Quantity</th>
                <th scope="col">Promised Date</th>
                <th scope="col">Scheduled Date</th>
                <th scope="col">Routing Progress</th>
                <th scope="col">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
                {% set primary_item = order.primary_item %}
                {% set scheduled_date = order.scheduled_completion_date or (primary_item.scheduled_completion_date if primary_item else None) %}
                <tr>
                    <td data-label="Order #">
                        <a href="{{ url_for('orders.view_order', order_id=order.id) }}" class="order-link">{{ order.order_number }}</a>
                    </td>
                    <td data-label="Finished Good">
                        {% if primary_item %}
                            <div class="finished-good">
                                <span class="sku">{{ primary_item.item.sku }}</span>
                                <span class="name">{{ primary_item.item.name }}</span>
                            </div>
                        {% else %}
                            <span class="muted">Not assigned</span>
                        {% endif %}
                    </td>
                    <td data-label="Quantity" class="numeric">{{ primary_item.quantity if primary_item else '—' }}</td>
                    <td data-label="Promised Date">
                        {{ order.promised_date.strftime('%Y-%m-%d') if order.promised_date else '—' }}
                    </td>
                    <td data-label="Scheduled Date">
                        {{ scheduled_date.strftime('%Y-%m-%d') if scheduled_date else '—' }}
                    </td>
                    <td data-label="Routing Progress">
                        {% if order.routing_progress is not none %}
                            {% set percent = (order.routing_progress * 100) | round(0, 'floor') %}
                            <div class="progress-chip">
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: {{ percent }}%"></div>
                                </div>
                                <span class="progress-label">{{ percent | int }}%</span>
                            </div>
                        {% else %}
                            <span class="muted">Not started</span>
                        {% endif %}
                    </td>
                    <td data-label="Status">
                        <span class="status-pill status-{{ order.status|lower }}">{{ order.status_label }}</span>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
    <div class="empty-state">
        {% if session.get('is_admin') %}
            <p>No open orders yet. Create a new order to get started.</p>
            <a href="{{ url_for('orders.new_order') }}" class="action-btn primary-action">Create New Order</a>
        {% else %}
            <p>No open orders yet.</p>
        {% endif %}
    </div>
{% endif %}
{% endblock %}
