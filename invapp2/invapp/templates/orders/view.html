{% extends "base.html" %}
{% block content %}
<h2>Order {{ order.order_number }}</h2>
<p>Status: {{ order.status_label }}</p>
<div class="order-metadata">
    <p><strong>Order Type:</strong> {{ order.order_type }}</p>
    <p><strong>Priority:</strong> {{ order.priority }}</p>
    <p><strong>Purchase Order #:</strong> {{ order.purchase_order_number }}</p>
    <p><strong>Customer:</strong> {{ order.customer_name or '—' }}</p>
    <p><strong>Created By:</strong> {{ order.created_by or '—' }}</p>
    <p><strong>Promise Date:</strong> {{ order.promised_date or 'TBD' }}</p>
    <p><strong>Scheduled Ship:</strong> {{ order.scheduled_ship_date or 'TBD' }}</p>
</div>
{% if order.general_notes %}
<section class="order-notes">
    <h3>Notes</h3>
    <p>{{ order.general_notes | e | replace('\n', '<br>') | safe }}</p>
</section>
{% endif %}

{% if order.gate_details %}
<section class="order-notes">
    <h3>Gate Details</h3>
    <div class="form-grid">
        <div><strong>Item Number:</strong> {{ order.gate_details.item_number }}</div>
        <div><strong>Production Quantity:</strong> {{ order.gate_details.production_quantity }}</div>
        <div><strong>Panel Count:</strong> {{ order.gate_details.panel_count }}</div>
        <div><strong>Total Gate Height:</strong> {{ order.gate_details.total_gate_height }}</div>
        <div><strong>AL Color:</strong> {{ order.gate_details.al_color }}</div>
        <div><strong>Acrylic/Wood/Vinyl Color:</strong> {{ order.gate_details.insert_color }}</div>
        <div><strong>Lead Post Direction:</strong> {{ order.gate_details.lead_post_direction }}</div>
        <div><strong>Visi Panels:</strong> {{ order.gate_details.visi_panels }}</div>
        <div><strong>1/2 Panel Color:</strong> {{ order.gate_details.half_panel_color }}</div>
    </div>
</section>
{% endif %}

{% if order.routing_progress is not none %}
    {% set percent = (order.routing_progress * 100) | round(0, 'floor') %}
    <p><strong>Routing Progress:</strong> {{ percent | int }}% complete</p>
{% else %}
    <p><strong>Routing Progress:</strong> Not started</p>
{% endif %}

<a href="{{ url_for('orders.edit_order', order_id=order.id) }}" class="action-btn">Edit</a>
<form method="post" action="{{ url_for('orders.delete_order', order_id=order.id) }}" style="display:inline;">
    <button type="submit">Delete</button>
</form>

{% if order.routing_steps %}
<h3>Routing Steps</h3>
<form method="post" action="{{ url_for('orders.update_routing', order_id=order.id) }}" class="form-stack">
    <table class="form-table">
        <thead>
            <tr>
                <th>Sequence</th>
                <th>Work Cell</th>
                <th>Instructions</th>
                <th>Completed</th>
            </tr>
        </thead>
        <tbody>
        {% for step in order.steps %}
            <tr>
                <td>{{ step.sequence }}</td>
                <td>{{ step.work_cell or '—' }}</td>
                <td>{{ step.description }}</td>
                <td class="numeric">
                    <label class="sr-only" for="step-{{ step.id }}">Mark step {{ step.sequence }} complete</label>
                    {% set pending = pending_completed_ids %}
                    {% if pending is not none %}
                        {% set is_checked = step.id in pending %}
                    {% else %}
                        {% set is_checked = step.completed %}
                    {% endif %}
                    <input id="step-{{ step.id }}" type="checkbox" name="completed_steps" value="{{ step.id }}" {% if is_checked %}checked{% endif %}>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="form-actions">
        <button type="submit" class="action-btn">Update Routing Status</button>
    </div>
</form>
{% endif %}
{% endblock %}
