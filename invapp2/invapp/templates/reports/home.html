{% extends "base.html" %}
{% block content %}
<h2>Reports</h2>

<form id="filters" class="bubble-form">
  <label>SKU: <input type="text" id="sku"></label>
  <label>Location: <input type="text" id="location"></label>
  <label>Start: <input type="date" id="start"></label>
  <label>End: <input type="date" id="end"></label>
  <button type="button" id="apply" class="bubble-btn">Apply</button>
</form>

<canvas id="trendChart" width="400" height="200"></canvas>
<table id="agingTable" class="table">
  <thead>
    <tr><th>SKU</th><th>Lot</th><th>Days</th><th>Qty</th></tr>
  </thead>
  <tbody></tbody>
</table>

<p>You can generate a full export of all tables as CSVs in a single ZIP file.</p>

<a href="{{ url_for('reports.generate_reports') }}" class="bubble-btn">Generate Reports (ZIP)</a>
<a id="customExport" href="{{ url_for('reports.export_filtered') }}" class="bubble-btn">Export Filtered (ZIP)</a>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadData(){
    const params = new URLSearchParams();
    ['sku','location','start','end'].forEach(id=>{
        const val=document.getElementById(id).value;
        if(val) params.append(id,val);
    });
    const res = await fetch('{{ url_for('reports.summary_data') }}?' + params.toString());
    const data = await res.json();
    const labels = data.movement_trends.map(d=>d.date);
    const qty = data.movement_trends.map(d=>d.quantity);
    chart.data.labels = labels;
    chart.data.datasets[0].data = qty;
    chart.update();
    const tbody = document.querySelector('#agingTable tbody');
    tbody.innerHTML = '';
    data.stock_aging.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.sku}</td><td>${r.lot_number}</td><td>${r.days}</td><td>${r.quantity}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('customExport').href = '{{ url_for('reports.export_filtered') }}?' + params.toString();
}
document.getElementById('apply').addEventListener('click', loadData);
const ctx = document.getElementById('trendChart').getContext('2d');
const chart = new Chart(ctx, {type:'line', data:{labels:[], datasets:[{label:'Movement Qty', data:[]}]}});
loadData();
</script>
{% endblock %}
