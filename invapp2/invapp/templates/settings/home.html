{% extends "base.html" %}

{% block content %}
<h2>Settings</h2>
<p class="page-intro">Configure the operations console, manage connected devices, and jump into administrator tools.</p>

<div class="settings-grid">
    <section class="card-section settings-card">
        <h3>Personalization</h3>
        <p>Switch the interface theme to match your environment.</p>
        <form method="post" action="{{ url_for('settings.toggle_theme') }}" class="stacked-form">
            <input type="hidden" name="next" value="{{ request.path }}">
            {% set is_dark = session.get('theme', 'dark') == 'dark' %}
            <button type="submit" class="action-btn">
                Switch to {{ 'Light' if is_dark else 'Dark' }} Mode
            </button>
        </form>
    </section>

    <section class="card-section settings-card">
        <h3>Devices</h3>
        <p>Manage printer destinations used across the console.</p>
        <a href="{{ url_for('printers.printer_settings') }}" class="action-btn">Manage Printers</a>
    </section>

    <section class="card-section settings-card">
        <h3>Administration</h3>
        <p>Review platform health and access critical tools.</p>
        <ul class="link-list">
            <li><a href="{{ url_for('admin.tools') }}" class="link-item">Admin Tools Overview</a></li>
            <li><a href="{{ url_for('reports.reports_home') }}" class="link-item">Operational Reports</a></li>
            <li><a href="{{ url_for('admin.data_backup') }}" class="link-item">Data Backup</a></li>
            {% if is_superuser() %}
            <li><a href="{{ url_for('useful_links.manage_links') }}" class="link-item">Manage Useful Links</a></li>
            <li><a href="{{ url_for('admin.backups_home') }}" class="link-item">Restore Backups</a></li>
            {% endif %}
        </ul>
    </section>

    {% if current_user.has_role('admin') or is_superuser() %}
    <section class="card-section settings-card">
        <h3>Backups</h3>
        <p>Manage the automated backup schedule.</p>
        <a href="{{ url_for('admin.backup_settings') }}" class="action-btn">Manage Backups</a>
    </section>

    <section class="card-section settings-card">
        <h3>Clear All Inventory (Start Fresh)</h3>
        <p>Reset on-hand inventory to zero by removing all stock movements, batches, and related inventory records. Items and locations are preserved.</p>
        <p class="muted">A backup snapshot will be created automatically before the wipe. If the backup fails, nothing is deleted.</p>
        {% if last_backup %}
        <p class="muted">
            Last backup: {{ last_backup.status|capitalize }}
            {% if last_backup.started_at %} &middot; {{ last_backup.started_at.strftime('%b %d, %Y %H:%M UTC') }}{% endif %}
        </p>
        {% if last_backup.message %}
        <p class="muted">{{ last_backup.message }}</p>
        {% endif %}
        {% else %}
        <p class="muted">No backups have been recorded yet.</p>
        {% endif %}
        <button type="button" class="action-btn danger" id="openClearInventoryModal">Clear All Inventory</button>
    </section>
    {% endif %}
</div>

{% if current_user.has_role('admin') or is_superuser() %}
<div id="clearInventoryModal" class="modal" role="dialog" aria-modal="true" aria-label="Clear all inventory confirmation">
    <div class="modal-content">
        <h3>Confirm Inventory Reset</h3>
        <p>This will permanently delete inventory quantities, stock movements, and related records. It cannot be undone.</p>
        <form method="post" action="{{ url_for('admin.clear_inventory') }}" class="stacked-form" id="clearInventoryForm">
            <input type="hidden" name="csrf_token" value="{{ clear_inventory_csrf_token }}">
            <label class="checkbox-row">
                <input type="checkbox" id="clearInventoryAck" name="acknowledge" value="1">
                I understand this will permanently delete inventory quantities and related records and cannot be undone.
            </label>
            <label for="clearInventoryPhrase">Type "{{ clear_inventory_phrase }}" to confirm</label>
            <input type="text" id="clearInventoryPhrase" name="confirm_phrase" autocomplete="off">
            <label for="clearInventoryPassword">Confirm your password</label>
            <input type="password" id="clearInventoryPassword" name="password" autocomplete="current-password">
            <div class="modal-actions">
                <button type="button" class="action-btn secondary" data-modal-close>Cancel</button>
                <button type="submit" class="action-btn danger" id="clearInventorySubmit" disabled>Yes, Clear Inventory</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if current_user.has_role('admin') or is_superuser() %}
<script>
    (() => {
        const openButton = document.getElementById('openClearInventoryModal');
        const modal = document.getElementById('clearInventoryModal');
        if (!openButton || !modal) {
            return;
        }
        const closeButtons = modal.querySelectorAll('[data-modal-close]');
        const checkbox = document.getElementById('clearInventoryAck');
        const phraseInput = document.getElementById('clearInventoryPhrase');
        const passwordInput = document.getElementById('clearInventoryPassword');
        const submitButton = document.getElementById('clearInventorySubmit');
        const confirmationPhrase = "{{ clear_inventory_phrase }}";

        const resetModal = () => {
            if (checkbox) checkbox.checked = false;
            if (phraseInput) phraseInput.value = "";
            if (passwordInput) passwordInput.value = "";
            if (submitButton) submitButton.disabled = true;
        };

        const updateSubmitState = () => {
            const ackOk = checkbox && checkbox.checked;
            const phraseOk = phraseInput && phraseInput.value.trim() === confirmationPhrase;
            const passwordOk = passwordInput && passwordInput.value.trim().length > 0;
            if (submitButton) {
                submitButton.disabled = !(ackOk && phraseOk && passwordOk);
            }
        };

        openButton.addEventListener('click', () => {
            resetModal();
            modal.style.display = 'block';
        });

        closeButtons.forEach((button) => {
            button.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        [checkbox, phraseInput, passwordInput].forEach((field) => {
            if (!field) return;
            field.addEventListener('input', updateSubmitState);
            field.addEventListener('change', updateSubmitState);
        });
    })();
</script>
{% endif %}
{% endblock %}
