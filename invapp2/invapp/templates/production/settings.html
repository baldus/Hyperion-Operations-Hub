{% extends "base.html" %}

{% block content %}
<nav class="production-nav" aria-label="Production pages">
    <a href="{{ url_for('production.daily_entry') }}" class="production-nav-link">Daily Entry</a>
    <a href="{{ url_for('production.history') }}" class="production-nav-link">History</a>
    <a href="{{ url_for('production.production_settings') }}" class="production-nav-link is-active">Settings</a>
</nav>

<h2>Production Settings</h2>
<p class="section-help">Configure which customers appear on the daily entry form, control their chart colors, and decide which ones should be grouped into the Other category.</p>
{% if grouped_customers %}
    <p class="chart-note">Grouped customers are currently rolled into the <strong>Other</strong> series: {{ grouped_customers | map(attribute='name') | join(', ') }}.</p>
{% endif %}

<section class="form-section">
    <h3>Manage Customers</h3>
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="update">
        <div class="table-scroll">
            <table class="inventory-table production-settings-table">
                <thead>
                    <tr>
                        <th scope="col">Customer</th>
                        <th scope="col">Color</th>
                        <th scope="col">Group into Other</th>
                        <th scope="col">Show on Entry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                        <tr class="{% if customer.is_other_bucket %}other-row{% endif %}">
                            <td>
                                {% if customer.is_other_bucket %}
                                    <strong>{{ customer.name }}</strong>
                                    <input type="hidden" name="name_{{ customer.id }}" value="{{ customer.name }}">
                                    <p class="field-note">Used for totals that do not belong to a specific customer.</p>
                                {% else %}
                                    <input type="text" name="name_{{ customer.id }}" value="{{ customer.name }}" required>
                                {% endif %}
                            </td>
                            <td>
                                <input type="color" name="color_{{ customer.id }}" value="{{ customer.color or '#3b82f6' }}" aria-label="Color for {{ customer.name }}">
                            </td>
                            <td>
                                {% if customer.is_other_bucket %}
                                    <span class="badge">Always on</span>
                                {% else %}
                                    <label class="checkbox-inline">
                                    <input type="checkbox" name="lump_into_other_{{ customer.id }}" {% if customer.lump_into_other %}checked{% endif %}>
                                    <span>Include with Other</span>
                                    </label>
                                {% endif %}
                            </td>
                            <td>
                                {% if customer.is_other_bucket %}
                                    <span class="badge">Required</span>
                                {% else %}
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="is_active_{{ customer.id }}" {% if customer.is_active %}checked{% endif %}>
                                        <span>Active</span>
                                    </label>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="form-actions">
            <button type="submit">Save Changes</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Add Customer</h3>
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="add">
        <div class="form-grid">
            <div class="form-field">
                <label for="new_customer_name" class="field-label">Customer Name</label>
                <input type="text" id="new_customer_name" name="new_customer_name" required>
            </div>
            <div class="form-field">
                <label for="new_customer_color" class="field-label">Chart Color</label>
                <input type="color" id="new_customer_color" name="new_customer_color" value="#3b82f6">
                <p class="field-note">Pick a color that will be used on stacked charts.</p>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit">Add Customer</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Gates Produced Chart</h3>
    <p class="section-help">
        Control the axis ranges for the Production History chart and optionally display a goal line.
    </p>
    {% set builder_defaults = chart_settings_form.custom_builder or {} %}
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="update_chart">
        <div class="form-grid">
            <fieldset>
                <legend>Primary Axis (Gates Produced)</legend>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="primary_min" class="field-label">Minimum</label>
                        <input type="number" step="0.01" id="primary_min" name="primary_min" value="{{ chart_settings_form.primary_min }}">
                        <p class="field-note">Leave blank to auto-scale.</p>
                    </div>
                    <div class="form-field">
                        <label for="primary_max" class="field-label">Maximum</label>
                        <input type="number" step="0.01" id="primary_max" name="primary_max" value="{{ chart_settings_form.primary_max }}">
                    </div>
                    <div class="form-field">
                        <label for="primary_step" class="field-label">Tick Increment</label>
                        <input type="number" step="0.01" id="primary_step" name="primary_step" value="{{ chart_settings_form.primary_step }}">
                        <p class="field-note">Applies to the gates produced axis.</p>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Secondary Axis (Output per Labor Hour)</legend>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="secondary_min" class="field-label">Minimum</label>
                        <input type="number" step="0.01" id="secondary_min" name="secondary_min" value="{{ chart_settings_form.secondary_min }}">
                        <p class="field-note">Leave blank to auto-scale.</p>
                    </div>
                    <div class="form-field">
                        <label for="secondary_max" class="field-label">Maximum</label>
                        <input type="number" step="0.01" id="secondary_max" name="secondary_max" value="{{ chart_settings_form.secondary_max }}">
                    </div>
                    <div class="form-field">
                        <label for="secondary_step" class="field-label">Tick Increment</label>
                        <input type="number" step="0.01" id="secondary_step" name="secondary_step" value="{{ chart_settings_form.secondary_step }}">
                        <p class="field-note">Applies to the labor hour axis.</p>
                    </div>
                </div>
            </fieldset>
        </div>
        <div class="form-grid">
            <div class="form-field">
                <label for="goal_value" class="field-label">Goal Value</label>
                <input type="number" step="0.01" id="goal_value" name="goal_value" value="{{ chart_settings_form.goal_value }}">
                <p class="field-note">Displayed as a dashed line on the primary axis.</p>
            </div>
            <div class="form-field">
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_goal" {% if chart_settings_form.show_goal %}checked{% endif %}>
                    <span>Show goal line on chart</span>
                </label>
            </div>
            <div class="form-field">
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_trend" {% if chart_settings_form.show_trend %}checked{% endif %}>
                    <span>Show Gates Produced Trend line</span>
                </label>
            </div>
        </div>
        <fieldset>
            <legend>Dashboard Graph Visibility</legend>
            <div class="form-grid">
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_shift_chart" {% if chart_settings_form.show_shift_chart %}checked{% endif %}>
                    <span>Show Production by Shift</span>
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_product_type_chart" {% if chart_settings_form.show_product_type_chart %}checked{% endif %}>
                    <span>Show Production by Product Type</span>
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_scrap_chart" {% if chart_settings_form.show_scrap_chart %}checked{% endif %}>
                    <span>Show Scrap and Reject Trends</span>
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_downtime_chart" {% if chart_settings_form.show_downtime_chart %}checked{% endif %}>
                    <span>Show Downtime Cause Analysis</span>
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="show_cumulative_goal_chart" {% if chart_settings_form.show_cumulative_goal_chart %}checked{% endif %}>
                    <span>Show Cumulative Production vs Goal</span>
                </label>
            </div>
        </fieldset>
        <fieldset>
            <legend>Custom Graph Builder Defaults</legend>
            <p class="field-note">Configure the default selections that load for users on the Production History page.</p>
            <div class="form-grid">
                <div class="form-field">
                    <label for="builder_dimension" class="field-label">Primary Dimension</label>
                    <select id="builder_dimension" name="builder_dimension">
                        <option value="" {% if not builder_defaults.get('dimension') %}selected{% endif %}>Date</option>
                        <option value="customer" {% if builder_defaults.get('dimension') == 'customer' %}selected{% endif %}>Customer</option>
                        <option value="product_type" {% if builder_defaults.get('dimension') == 'product_type' %}selected{% endif %}>Product Type</option>
                        <option value="shift" {% if builder_defaults.get('dimension') == 'shift' %}selected{% endif %}>Shift</option>
                        <option value="downtime_cause" {% if builder_defaults.get('dimension') == 'downtime_cause' %}selected{% endif %}>Downtime Cause</option>
                        <option value="day_of_week" {% if builder_defaults.get('dimension') == 'day_of_week' %}selected{% endif %}>Day of Week</option>
                        <option value="month" {% if builder_defaults.get('dimension') == 'month' %}selected{% endif %}>Month</option>
                        <option value="week" {% if builder_defaults.get('dimension') == 'week' %}selected{% endif %}>Week</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="builder_series" class="field-label">Breakdown Series (optional)</label>
                    <select id="builder_series" name="builder_series">
                        <option value="" {% if not builder_defaults.get('series') %}selected{% endif %}>None</option>
                        <option value="customer" {% if builder_defaults.get('series') == 'customer' %}selected{% endif %}>Customer</option>
                        <option value="product_type" {% if builder_defaults.get('series') == 'product_type' %}selected{% endif %}>Product Type</option>
                        <option value="shift" {% if builder_defaults.get('series') == 'shift' %}selected{% endif %}>Shift</option>
                        <option value="downtime_cause" {% if builder_defaults.get('series') == 'downtime_cause' %}selected{% endif %}>Downtime Cause</option>
                        <option value="day_of_week" {% if builder_defaults.get('series') == 'day_of_week' %}selected{% endif %}>Day of Week</option>
                        <option value="month" {% if builder_defaults.get('series') == 'month' %}selected{% endif %}>Month</option>
                        <option value="week" {% if builder_defaults.get('series') == 'week' %}selected{% endif %}>Week</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="builder_metric" class="field-label">Metric</label>
                    <select id="builder_metric" name="builder_metric">
                        <option value="gates_produced" {% if builder_defaults.get('metric') == 'gates_produced' or not builder_defaults.get('metric') %}selected{% endif %}>Gates Produced</option>
                        <option value="gates_packaged" {% if builder_defaults.get('metric') == 'gates_packaged' %}selected{% endif %}>Gates Packaged</option>
                        <option value="scrap" {% if builder_defaults.get('metric') == 'scrap' %}selected{% endif %}>Scrap / Rejects</option>
                        <option value="runtime_hours" {% if builder_defaults.get('metric') == 'runtime_hours' %}selected{% endif %}>Runtime Hours</option>
                        <option value="overtime_hours" {% if builder_defaults.get('metric') == 'overtime_hours' %}selected{% endif %}>Overtime Hours</option>
                        <option value="produced_per_hour" {% if builder_defaults.get('metric') == 'produced_per_hour' %}selected{% endif %}>Produced per Hour</option>
                        <option value="efficiency" {% if builder_defaults.get('metric') == 'efficiency' %}selected{% endif %}>Efficiency</option>
                        <option value="goal" {% if builder_defaults.get('metric') == 'goal' %}selected{% endif %}>Goal</option>
                        <option value="goal_gap" {% if builder_defaults.get('metric') == 'goal_gap' %}selected{% endif %}>Goal Gap</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="builder_aggregation" class="field-label">Aggregation</label>
                    <select id="builder_aggregation" name="builder_aggregation">
                        <option value="sum" {% if builder_defaults.get('aggregation') == 'sum' or not builder_defaults.get('aggregation') %}selected{% endif %}>Sum</option>
                        <option value="average" {% if builder_defaults.get('aggregation') == 'average' %}selected{% endif %}>Average</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="builder_chart_type" class="field-label">Default Chart Type</label>
                    <select id="builder_chart_type" name="builder_chart_type">
                        <option value="bar" {% if builder_defaults.get('chart_type') == 'bar' or not builder_defaults.get('chart_type') %}selected{% endif %}>Bar</option>
                        <option value="line" {% if builder_defaults.get('chart_type') == 'line' %}selected{% endif %}>Line</option>
                        <option value="stacked" {% if builder_defaults.get('chart_type') == 'stacked' %}selected{% endif %}>Stacked Bar</option>
                    </select>
                </div>
            </div>
        </fieldset>
        <div class="form-actions">
            <button type="submit">Save Chart Settings</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Output per Labor Hour</h3>
    <p class="section-help">
        Customize the variables and formula that power the Production History "Output per Labor Hour" column.
    </p>
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="update_formula">
        <div class="form-field">
            <label for="output_formula" class="field-label">Formula</label>
            <textarea id="output_formula" name="output_formula" rows="2" required>{{ output_formula_form.formula }}</textarea>
            <p class="field-note">
                Reference variables by name. Example: <code>combined_output / total_hours</code>.
            </p>
        </div>
        <div class="form-field">
            <span class="field-label">Variables</span>
            <div class="table-scroll">
                <table class="inventory-table production-settings-table">
                    <thead>
                        <tr>
                            <th scope="col">Variable Name</th>
                            <th scope="col">Display Label</th>
                            <th scope="col">Expression</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set existing_variables = output_formula_form.variables or [] %}
                        {% set total_rows = existing_variables|length + 2 %}
                        {% for idx in range(total_rows) %}
                            {% set variable = existing_variables[idx] if idx < existing_variables|length else None %}
                            <tr>
                                <td>
                                    <input type="text" name="variable_name" value="{{ variable.name if variable else '' }}" placeholder="combined_output">
                                </td>
                                <td>
                                    <input type="text" name="variable_label" value="{{ variable.label if variable else '' }}" placeholder="Combined Output">
                                </td>
                                <td>
                                    <input type="text" name="variable_expression" value="{{ variable.expression if variable else '' }}" placeholder="produced + packaged">
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="field-note">Expressions can reference the base metrics listed below.</p>
            <ul class="field-note">
                {% for metric in formula_metric_hints %}
                    <li><code>{{ metric.key }}</code> &mdash; {{ metric.description }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="form-actions">
            <button type="submit">Save Formula</button>

        </div>
    </form>
</section>
{% endblock %}
