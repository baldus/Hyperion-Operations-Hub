{% extends "base.html" %}

{% block content %}
<nav class="production-nav" aria-label="Production pages">
    <a href="{{ url_for('production.daily_entry') }}" class="production-nav-link">Daily Entry</a>
    <a href="{{ url_for('production.history') }}" class="production-nav-link">History</a>
    <a href="{{ url_for('production.production_settings') }}" class="production-nav-link is-active">Settings</a>
</nav>

<h2>Production Settings</h2>
<p class="section-help">Configure which customers appear on the daily entry form, control their chart colors, and decide which ones should be grouped into the Other category.</p>
{% if grouped_customers %}
    <p class="chart-note">Grouped customers are currently rolled into the <strong>Other</strong> series: {{ grouped_customers | map(attribute='name') | join(', ') }}.</p>
{% endif %}

<section class="form-section">
    <h3>Manage Customers</h3>
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="update">
        <div class="table-scroll">
            <table class="inventory-table production-settings-table">
                <thead>
                    <tr>
                        <th scope="col">Customer</th>
                        <th scope="col">Color</th>
                        <th scope="col">Group into Other</th>
                        <th scope="col">Show on Entry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                        <tr class="{% if customer.is_other_bucket %}other-row{% endif %}">
                            <td>
                                {% if customer.is_other_bucket %}
                                    <strong>{{ customer.name }}</strong>
                                    <input type="hidden" name="name_{{ customer.id }}" value="{{ customer.name }}">
                                    <p class="field-note">Used for totals that do not belong to a specific customer.</p>
                                {% else %}
                                    <input type="text" name="name_{{ customer.id }}" value="{{ customer.name }}" required>
                                {% endif %}
                            </td>
                            <td>
                                <input type="color" name="color_{{ customer.id }}" value="{{ customer.color or '#3b82f6' }}" aria-label="Color for {{ customer.name }}">
                            </td>
                            <td>
                                {% if customer.is_other_bucket %}
                                    <span class="badge">Always on</span>
                                {% else %}
                                    <label class="checkbox-inline">
                                    <input type="checkbox" name="lump_into_other_{{ customer.id }}" {% if customer.lump_into_other %}checked{% endif %}>
                                    <span>Include with Other</span>
                                    </label>
                                {% endif %}
                            </td>
                            <td>
                                {% if customer.is_other_bucket %}
                                    <span class="badge">Required</span>
                                {% else %}
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="is_active_{{ customer.id }}" {% if customer.is_active %}checked{% endif %}>
                                        <span>Active</span>
                                    </label>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="form-actions">
            <button type="submit">Save Changes</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Add Customer</h3>
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="add">
        <div class="form-grid">
            <div class="form-field">
                <label for="new_customer_name" class="field-label">Customer Name</label>
                <input type="text" id="new_customer_name" name="new_customer_name" required>
            </div>
            <div class="form-field">
                <label for="new_customer_color" class="field-label">Chart Color</label>
                <input type="color" id="new_customer_color" name="new_customer_color" value="#3b82f6">
                <p class="field-note">Pick a color that will be used on stacked charts.</p>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit">Add Customer</button>
        </div>
    </form>
</section>

<section class="form-section">
    <h3>Chart Display Settings</h3>
    <form method="post" class="form-stack">
        <input type="hidden" name="action" value="update_chart">
        <div class="form-grid chart-settings-grid">
            <div class="form-field">
                <label class="field-label" for="primary_min">Primary Axis Minimum</label>
                <input type="number" step="0.01" id="primary_min" name="primary_min" value="{{ chart_settings.primary_min if chart_settings.primary_min is not none else '' }}">
                <p class="field-note">Controls the starting value for gates produced.</p>
            </div>
            <div class="form-field">
                <label class="field-label" for="primary_max">Primary Axis Maximum</label>
                <input type="number" step="0.01" id="primary_max" name="primary_max" value="{{ chart_settings.primary_max if chart_settings.primary_max is not none else '' }}">
            </div>
            <div class="form-field">
                <label class="field-label" for="primary_step">Primary Axis Step</label>
                <input type="number" step="0.01" id="primary_step" name="primary_step" value="{{ chart_settings.primary_step if chart_settings.primary_step is not none else '' }}">
                <p class="field-note">Set the tick interval for gates produced.</p>
            </div>
        </div>
        <div class="form-grid chart-settings-grid">
            <div class="form-field">
                <label class="field-label" for="secondary_min">Secondary Axis Minimum</label>
                <input type="number" step="0.01" id="secondary_min" name="secondary_min" value="{{ chart_settings.secondary_min if chart_settings.secondary_min is not none else '' }}">
                <p class="field-note">Used for the output per labor hour line.</p>
            </div>
            <div class="form-field">
                <label class="field-label" for="secondary_max">Secondary Axis Maximum</label>
                <input type="number" step="0.01" id="secondary_max" name="secondary_max" value="{{ chart_settings.secondary_max if chart_settings.secondary_max is not none else '' }}">
            </div>
            <div class="form-field">
                <label class="field-label" for="secondary_step">Secondary Axis Step</label>
                <input type="number" step="0.01" id="secondary_step" name="secondary_step" value="{{ chart_settings.secondary_step if chart_settings.secondary_step is not none else '' }}">
            </div>
        </div>
        <div class="form-grid chart-settings-grid">
            <div class="form-field">
                <label class="field-label" for="goal_value">Goal Line Value</label>
                <input type="number" step="0.01" id="goal_value" name="goal_value" value="{{ chart_settings.goal_value if chart_settings.goal_value is not none else '' }}">
                <p class="field-note">Displayed on the primary axis when enabled.</p>
            </div>
            <div class="form-field checkbox-field">
                <label class="checkbox-inline">
                    <input type="checkbox" id="show_goal" name="show_goal" {% if chart_settings.show_goal and chart_settings.goal_value is not none %}checked{% endif %}>
                    <span>Show goal line on chart</span>
                </label>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit">Save Chart Settings</button>
        </div>
    </form>
</section>
{% endblock %}
