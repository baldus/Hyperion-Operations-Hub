{% extends "base.html" %}

{% block content %}
<nav class="production-nav" aria-label="Production pages">
    <a href="{{ url_for('production.daily_entry') }}" class="production-nav-link">Daily Entry</a>
    <a href="{{ url_for('production.history') }}" class="production-nav-link is-active">History</a>
    <a href="{{ url_for('production.production_settings') }}" class="production-nav-link">Settings</a>
</nav>

<h2>Production History</h2>
<p class="section-help">Select a date range to review production totals, customer breakdowns, and month-to-date trends.</p>
{% if grouped_customer_names %}
    <p class="chart-note">Customers grouped into the <strong>Other</strong> series: {{ grouped_customer_names | join(', ') }}.</p>
{% endif %}


<form method="get" class="date-range-form">
    <div class="form-field">
        <label for="start_date" class="field-label">Start Date</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date.isoformat() }}">
    </div>
    <div class="form-field">
        <label for="end_date" class="field-label">End Date</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date.isoformat() }}">
    </div>
    <div class="form-actions">
        <button type="submit">Update Range</button>
    </div>
</form>

{% if not chart_labels %}
    <p class="chart-empty">No production records were found for the selected dates.</p>
{% else %}
    <section class="dashboard-section">
        <h3>Visual Breakdown</h3>
        <div class="chart-controls">
            <div class="chart-control-group">
                <span class="chart-control-title">Customers</span>
                <div class="chart-toggle-grid" data-chart-target="gates-produced">
                    {% for dataset in stacked_datasets %}
                        <label class="toggle-chip">
                            <input type="checkbox" data-dataset-index="{{ loop.index0 }}" checked>
                            <span class="color-dot" style="background-color: {{ dataset.backgroundColor }}"></span>
                            {{ dataset.label }}
                        </label>
                    {% endfor %}
                </div>
            </div>
            <div class="chart-control-group">
                <span class="chart-control-title">Production Metrics</span>
                <div class="chart-toggle-grid" data-chart-target="cumulative-lines">
                    {% for dataset in line_datasets %}
                        <label class="toggle-chip">
                            <input type="checkbox" data-dataset-index="{{ loop.index0 }}" checked>
                            <span class="color-dot" style="background-color: {{ dataset.borderColor }}"></span>
                            {{ dataset.label }}
                        </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="chart-grid">
            <div class="chart-card">
                <canvas id="gatesProducedChart" aria-label="Stacked column chart showing gates produced per customer"></canvas>
            </div>
            <div class="chart-card">
                <canvas id="cumulativeChart" aria-label="Line chart showing cumulative month-to-date production totals"></canvas>
            </div>
        </div>
    </section>

    <section class="dashboard-section">
        <h3>Daily Detail</h3>
        <p class="section-help">Labor hours assume an 8-hour base shift per employee plus the overtime entered for each section.</p>
        <div class="table-scroll">
            <table class="inventory-table production-history-table">
                <thead>
                    <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Day</th>
                        <th scope="col">Gates Produced</th>
                        <th scope="col">Gates Packaged</th>
                        <th scope="col">Gates Labor<br><small>Employees / OT / Hours</small></th>
                        <th scope="col">Output per Labor Hour<br><small>Gates Combined</small></th>
                        <th scope="col">Controllers<br><small>4 Stop / 6 Stop</small></th>
                        <th scope="col">Door Locks<br><small>LH / RH</small></th>
                        <th scope="col">Operators</th>
                        <th scope="col">COPs</th>
                        <th scope="col">Additional Labor<br><small>Employees / OT / Hours</small></th>
                        <th scope="col">Additional Output<br><small>Units per Labor Hour</small></th>
                        <th scope="col">Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_rows %}
                        <tr>
                            <td>{{ row.record.entry_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ row.record.day_of_week }}</td>
                            <td>
                                <strong>{{ row.produced_sum }}</strong>
                                <div class="totals-breakdown">
                                    {% for customer in customers %}
                                        <span>{{ customer.name }}: {{ row.per_customer_produced.get(customer.id, 0) }}</span>

                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                <strong>{{ row.packaged_sum }}</strong>
                                <div class="totals-breakdown">
                                    {% for customer in customers %}
                                        <span>{{ customer.name }}: {{ row.per_customer_packaged.get(customer.id, 0) }}</span>

                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                <div class="totals-breakdown">
                                    <span>Employees: {{ row.gates_employees }}</span>
                                    <span>OT Hours: {{ row.gates_hours_ot }}</span>
                                    <span>Total Hours: {{ row.gates_total_hours }}</span>
                                </div>
                            </td>
                            <td>
                                {% if row.gates_output_per_hour %}
                                    <strong>{{ row.gates_output_per_hour }}</strong>
                                {% endif %}
                                {% if row.output_variables %}
                                    <div class="totals-breakdown">
                                        {% for metric in row.output_variables %}
                                            <span>{{ metric.label }}: {{ metric.value }}</span>
                                        {% endfor %}
                                    </div>
                                {% elif not row.gates_output_per_hour %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                <div class="metric-pair">
                                    <span>{{ row.record.controllers_4_stop }}</span>
                                    <span>{{ row.record.controllers_6_stop }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="metric-pair">
                                    <span>{{ row.record.door_locks_lh }}</span>
                                    <span>{{ row.record.door_locks_rh }}</span>
                                </div>
                            </td>
                            <td>{{ row.operators_total }}</td>
                            <td>{{ row.cops_total }}</td>
                            <td>
                                <div class="totals-breakdown">
                                    <span>Employees: {{ row.additional_employees }}</span>
                                    <span>OT Hours: {{ row.additional_hours_ot }}</span>
                                    <span>Total Hours: {{ row.additional_total_hours }}</span>
                                </div>
                            </td>
                            <td>
                                {% if row.additional_per_hour %}
                                    <div class="totals-breakdown">
                                        {% for metric in row.additional_per_hour %}
                                            <span>{{ metric.label }}: {{ metric.per_hour }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>{{ row.record.daily_notes or '—' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartLabels = {{ chart_labels|tojson }};
    const stackedDatasets = {{ stacked_datasets|tojson }};
    const lineDatasets = {{ line_datasets|tojson }};

    if (chartLabels.length) {
        const barContext = document.getElementById('gatesProducedChart');
        let barChart = null;
        if (barContext) {
            barChart = new Chart(barContext, {

                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: stackedDatasets,
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gates Produced by Customer',
                        },
                        legend: {
                            position: 'bottom',
                        },
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units',
                            },
                        },
                    },
                },
            });
        }

        const lineContext = document.getElementById('cumulativeChart');
        let lineChart = null;
        if (lineContext) {
            lineChart = new Chart(lineContext, {

                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: lineDatasets,
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cumulative Month-to-Date Totals',
                        },
                        legend: {
                            position: 'bottom',
                        },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units',
                            },
                        },
                    },
                },
            });
        }

        const customerToggleGrid = document.querySelector('.chart-toggle-grid[data-chart-target="gates-produced"]');
        if (customerToggleGrid && barChart) {
            customerToggleGrid.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
                checkbox.addEventListener('change', (event) => {
                    const datasetIndex = Number(event.target.dataset.datasetIndex);
                    if (!Number.isNaN(datasetIndex) && barChart.data.datasets[datasetIndex]) {
                        barChart.data.datasets[datasetIndex].hidden = !event.target.checked;
                        barChart.update();
                    }
                });
            });
        }

        const lineToggleGrid = document.querySelector('.chart-toggle-grid[data-chart-target="cumulative-lines"]');
        if (lineToggleGrid && lineChart) {
            lineToggleGrid.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
                checkbox.addEventListener('change', (event) => {
                    const datasetIndex = Number(event.target.dataset.datasetIndex);
                    if (!Number.isNaN(datasetIndex) && lineChart.data.datasets[datasetIndex]) {
                        lineChart.data.datasets[datasetIndex].hidden = !event.target.checked;
                        lineChart.update();
                    }
                });
            });
        }

    }
</script>
{% endblock %}
