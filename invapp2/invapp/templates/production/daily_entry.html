{% extends "base.html" %}

{% block content %}
<nav class="production-nav" aria-label="Production pages">
    <a href="{{ url_for('production.daily_entry') }}" class="production-nav-link is-active">Daily Entry</a>
    <a href="{{ url_for('production.final_process_entry') }}" class="production-nav-link">Final Process Entry</a>
    <a href="{{ url_for('production.history') }}" class="production-nav-link">History</a>
    <a href="{{ url_for('production.production_settings') }}" class="production-nav-link">Settings</a>
</nav>

<h2>Daily Production Entry</h2>
<p class="section-help">Record production totals for each customer and component. Use the selector below to view or update a different day.</p>
{% if grouped_customers %}
    <p class="chart-note">The following customers will be rolled into the <strong>Other</strong> category on dashboards: {{ grouped_customers | map(attribute='name') | join(', ') }}.</p>
{% endif %}


<form method="get" class="date-selector" aria-label="Load production entry for a different day">
    <label for="entry_date_lookup" class="field-label">Jump to Date</label>
    <div class="date-selector-controls">
        <input type="date" id="entry_date_lookup" name="entry_date" value="{{ selected_date.isoformat() }}">
        <button type="submit" class="action-btn">Load</button>
    </div>
</form>

<form method="post" class="form-stack production-entry-form">
    <div class="form-section">
        <div class="form-grid">
            <div class="form-field">
                <label for="entry_date" class="field-label">Entry Date</label>
                <input type="date" id="entry_date" name="entry_date" value="{{ selected_date.isoformat() }}" {% if record_exists %}disabled{% endif %}>
                {% if record_exists %}
                    <input type="hidden" name="entry_date" value="{{ selected_date.isoformat() }}">
                    <p class="field-note">The entry date is locked because this record already exists. Use the selector above to load a different day.</p>
                {% else %}
                    <p class="field-note">Defaulted to today. Adjust if you are entering totals for a different day.</p>
                {% endif %}
            </div>
            <div class="form-field">
                <label class="field-label">Day of Week</label>
                <input type="text" value="{{ selected_date.strftime('%A') }}" disabled>
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="section-heading">
            <h3>Gates Packaged</h3>
            <a href="{{ url_for('production.production_settings') }}" class="section-link">Manage customers</a>
        </div>

        <div class="form-grid">
            <div class="form-field">
                <label for="gates_employees" class="field-label">Number of Employees</label>
                <input type="number" min="0" step="1" id="gates_employees" name="gates_employees" value="{{ form_values.gates_employees }}">
            </div>
            <div class="form-field">
                <label for="gates_hours_ot" class="field-label">Hours OT Worked</label>
                <input type="number" min="0" step="0.25" id="gates_hours_ot" name="gates_hours_ot" value="{{ form_values.gates_hours_ot }}">
                <p class="field-note">Enter total overtime hours worked by the gates crew.</p>
            </div>
        </div>

        <p class="section-help">Track a single packaged value per customer. Totals roll into <strong>Other</strong> automatically for grouped customers.</p>

        {% set packaged_totals = namespace(value=0) %}
        <div class="production-customer-grid">
            {% for customer in customers %}
                {% set packaged_totals.value = packaged_totals.value + (form_values.gates_packaged[customer.id]|int) %}
                {% set input_id = 'gates_packaged_' ~ customer.id %}
                <div class="production-customer-card">
                    <div class="production-customer-header">
                        <span class="production-customer-name">{{ customer.name }}</span>
                        {% if customer.lump_into_other and not customer.is_other_bucket %}
                            <span class="customer-chip" title="Counts are rolled into Other on charts">Grouped</span>
                        {% endif %}
                        {% if customer.is_other_bucket %}
                            <span class="customer-chip customer-chip--accent">Other Bucket</span>
                        {% endif %}
                    </div>
                    <label for="{{ input_id }}" class="production-metric-label">Gates Packaged</label>
                    <input type="number" min="0" step="1" id="{{ input_id }}" name="gates_packaged_{{ customer.id }}" value="{{ form_values.gates_packaged[customer.id] }}" class="production-metric-input">
                </div>
            {% endfor %}
        </div>

        <div class="production-customer-footer">
            <div class="production-total-card" aria-live="polite">
                <span class="production-total-label">Total Packaged</span>
                <span class="production-total-value">{{ packaged_totals.value }}</span>
            </div>
            <button type="submit" name="fill_packaged_from_completions" value="1" class="action-btn secondary">Apply Finished Gate Totals</button>
        </div>
    </div>

    <div class="form-section">
        <h3>Additional Production Totals</h3>
        <div class="form-grid">
            <div class="form-field">
                <label for="additional_employees" class="field-label">Number of Employees</label>
                <input type="number" min="0" step="1" id="additional_employees" name="additional_employees" value="{{ form_values.additional_employees }}">
            </div>
            <div class="form-field">
                <label for="additional_hours_ot" class="field-label">Hours OT Worked</label>
                <input type="number" min="0" step="0.25" id="additional_hours_ot" name="additional_hours_ot" value="{{ form_values.additional_hours_ot }}">
                <p class="field-note">Enter total overtime hours worked by the additional production team.</p>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-field">
                <label for="controllers_4_stop" class="field-label">Controllers (4 Stop)</label>
                <input type="number" min="0" id="controllers_4_stop" name="controllers_4_stop" value="{{ form_values.controllers_4_stop }}">
            </div>
            <div class="form-field">
                <label for="controllers_6_stop" class="field-label">Controllers (6 Stop)</label>
                <input type="number" min="0" id="controllers_6_stop" name="controllers_6_stop" value="{{ form_values.controllers_6_stop }}">
            </div>
            <div class="form-field">
                <label for="door_locks_lh" class="field-label">Door Locks (LH)</label>
                <input type="number" min="0" id="door_locks_lh" name="door_locks_lh" value="{{ form_values.door_locks_lh }}">
            </div>
            <div class="form-field">
                <label for="door_locks_rh" class="field-label">Door Locks (RH)</label>
                <input type="number" min="0" id="door_locks_rh" name="door_locks_rh" value="{{ form_values.door_locks_rh }}">
            </div>
            <div class="form-field">
                <label for="operators_produced" class="field-label">Operators Produced</label>
                <input type="number" min="0" id="operators_produced" name="operators_produced" value="{{ form_values.operators_produced }}">
            </div>
            <div class="form-field">
                <label for="cops_produced" class="field-label">COPs Produced</label>
                <input type="number" min="0" id="cops_produced" name="cops_produced" value="{{ form_values.cops_produced }}">
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Daily Notes</h3>
        <textarea id="daily_notes" name="daily_notes" placeholder="Add any notes about the day's production...">{{ form_values.daily_notes }}</textarea>
    </div>

    <div class="form-section">
        <div class="section-heading">
            <h3>Finished Gate Orders</h3>
            <p class="section-help">Entries captured from the final process closeout form can be reviewed and adjusted below.</p>
        </div>
        <div class="table-scroll">
            <table class="form-table production-table">
                <thead>
                    <tr>
                        <th scope="col">Order #</th>
                        <th scope="col">Customer</th>
                        <th scope="col">Gates Completed</th>
                        <th scope="col">PO #</th>
                        <th scope="col">Remove</th>
                    </tr>
                </thead>
                <tbody>
                    {% for completion in form_values.gate_completions %}
                        <tr>
                            <td>
                                <input type="hidden" name="completion_id" value="{{ completion.id }}">
                                <input type="text" name="completion_order_number" value="{{ completion.order_number }}" required>
                            </td>
                            <td>
                                <input type="text" name="completion_customer" value="{{ completion.customer_name }}">
                            </td>
                            <td>
                                <input type="number" min="0" step="1" name="completion_gate_count" value="{{ completion.gates_completed }}">
                            </td>
                            <td>
                                <input type="text" name="completion_po_number" value="{{ completion.po_number }}">
                            </td>
                            <td class="table-cell-center">
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="completion_delete_ids" value="{{ completion.id }}" {% if completion.marked_for_delete %}checked{% endif %}>
                                    Remove
                                </label>
                            </td>
                        </tr>
                    {% endfor %}
                    {% for _ in range(extra_completion_rows) %}
                        <tr>
                            <td>
                                <input type="hidden" name="completion_id" value="">
                                <input type="text" name="completion_order_number" value="">
                            </td>
                            <td>
                                <input type="text" name="completion_customer" value="">
                            </td>
                            <td>
                                <input type="number" min="0" step="1" name="completion_gate_count" value="">
                            </td>
                            <td>
                                <input type="text" name="completion_po_number" value="">
                            </td>
                            <td class="table-cell-center">
                                <span class="field-note">&mdash;</span>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="field-note">To delete an existing row, check <strong>Remove</strong> and save. Leave blank rows empty to add nothing new.</p>
    </div>

    <div class="form-actions">
        <a href="{{ url_for('production.history', start_date=selected_date.replace(day=1).isoformat(), end_date=selected_date.isoformat()) }}" class="action-btn secondary-link">View Month-to-Date</a>
        <button type="submit">Save Daily Totals</button>
    </div>
</form>
{% endblock %}
